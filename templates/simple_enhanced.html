<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助手</title>
    
    <!-- Bootstrap CSS with Replit dark theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #1a1a1a; color: #ffffff; }
        .chat-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .chat-messages { height: 400px; overflow-y: auto; background-color: #2a2a2a; border-radius: 10px; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
        .message.user { background-color: #007bff; text-align: right; }
        .message.assistant { background-color: #333; }
        .avatar-section { background-color: #2a2a2a; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .avatar-preview { width: 80px; height: 80px; border: 2px solid #007bff; border-radius: 50%; padding: 5px; background: #f8f9fa; display: flex; justify-content: center; align-items: center; }
        .avatar-svg { border-radius: 50%; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="chat-container">
            <!-- Header with Avatar -->
            <div class="avatar-section">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div id="avatarPreview" class="avatar-preview">
                            <svg width="70" height="70" viewBox="0 0 120 120" class="avatar-svg">
                                <circle cx="60" cy="45" r="25" fill="#FFE4B5" stroke="#D2B48C" stroke-width="2"/>
                                <circle cx="52" cy="40" r="3" fill="#333" id="leftEye"/>
                                <circle cx="68" cy="40" r="3" fill="#333" id="rightEye"/>
                                <path d="M 50 50 Q 60 58 70 50" stroke="#333" stroke-width="2" fill="none" id="mouth"/>
                                <path d="M 35 35 Q 60 15 85 35" fill="#8B4513" id="hair"/>
                                <rect x="45" y="70" width="30" height="35" fill="#4169E1" rx="5" id="body"/>
                            </svg>
                        </div>
                    </div>
                    <div class="col">
                        <h4 id="aiName">AI助手</h4>
                        <p class="mb-0 text-muted" id="aiPersonality">友善的助手</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#avatarSettings">
                            <i class="fas fa-cog"></i> 自定義
                        </button>
                    </div>
                </div>
                
                <!-- Avatar Settings (Collapsible) -->
                <div class="collapse mt-3" id="avatarSettings">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label">名稱</label>
                            <input type="text" class="form-control form-control-sm" id="nameInput" value="AI助手">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">個性</label>
                            <select class="form-select form-select-sm" id="personalitySelect">
                                <option value="friendly">友善的</option>
                                <option value="professional">專業的</option>
                                <option value="playful">活潑的</option>
                                <option value="wise">智慧的</option>
                                <option value="creative">創意的</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">髮色</label>
                            <select class="form-select form-select-sm" id="hairColorSelect">
                                <option value="#8B4513">棕色</option>
                                <option value="#000000">黑色</option>
                                <option value="#FFD700">金色</option>
                                <option value="#FF6347">紅色</option>
                                <option value="#4169E1">藍色</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">服裝</label>
                            <select class="form-select form-select-sm" id="bodyColorSelect">
                                <option value="#4169E1">藍色</option>
                                <option value="#FF6347">紅色</option>
                                <option value="#32CD32">綠色</option>
                                <option value="#9370DB">紫色</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-primary btn-sm" onclick="saveSettings()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                        <button class="btn btn-success btn-sm" onclick="generateAvatar()">
                            <i class="fas fa-image"></i> 生成頭像
                        </button>
                        <button class="btn btn-info btn-sm" onclick="testVoice()">
                            <i class="fas fa-volume-up"></i> 測試語音
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-messages p-3 mb-3">
                <div class="message assistant">
                    <strong>AI助手:</strong> 你好！我是你的AI助手。有什麼可以幫助你的嗎？
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="input-group mb-3">
                <textarea id="messageInput" class="form-control" placeholder="輸入你的訊息..." rows="3"></textarea>
                <button id="sendBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> 發送
                </button>
            </div>
            
            <!-- Quick Actions -->
            <div class="row mb-3">
                <div class="col-6 col-md-3 mb-2">
                    <button class="btn btn-outline-secondary w-100 btn-sm" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> 清除歷史
                    </button>
                </div>
                <div class="col-6 col-md-3 mb-2">
                    <button class="btn btn-outline-info w-100 btn-sm" onclick="generateImage()">
                        <i class="fas fa-image"></i> 生成圖片
                    </button>
                </div>
                <div class="col-6 col-md-3 mb-2">
                    <button class="btn btn-outline-warning w-100 btn-sm" onclick="generateQR()">
                        <i class="fas fa-qrcode"></i> QR碼
                    </button>
                </div>
                <div class="col-6 col-md-3 mb-2">
                    <button class="btn btn-outline-success w-100 btn-sm" onclick="generateDoc()">
                        <i class="fas fa-file"></i> 文件
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // AI Avatar Settings
        let avatarSettings = {
            name: 'AI助手',
            personality: 'friendly',
            hairColor: '#8B4513',
            bodyColor: '#4169E1'
        };

        // DOM Elements
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Core Functions
        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? '你' : avatarSettings.name}:</strong> ${content}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        avatar_settings: avatarSettings
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`錯誤: ${data.error}`, 'assistant');
                }
            } catch (error) {
                addMessage(`連線錯誤: ${error.message}`, 'assistant');
            }
        }

        async function clearHistory() {
            try {
                const response = await fetch('/clear_history', { method: 'POST' });
                if (response.ok) {
                    chatMessages.innerHTML = `<div class="message assistant">
                        <strong>${avatarSettings.name}:</strong> 聊天記錄已清除！
                    </div>`;
                }
            } catch (error) {
                addMessage('清除記錄失敗', 'assistant');
            }
        }

        // Avatar Functions
        function updateAvatar() {
            const name = document.getElementById('nameInput').value;
            const personality = document.getElementById('personalitySelect').value;
            const hairColor = document.getElementById('hairColorSelect').value;
            const bodyColor = document.getElementById('bodyColorSelect').value;

            avatarSettings = { name, personality, hairColor, bodyColor };

            document.getElementById('aiName').textContent = name;
            
            const personalityTexts = {
                'friendly': '友善的助手',
                'professional': '專業的顧問',
                'playful': '活潑的夥伴',
                'wise': '智慧的導師',
                'creative': '創意的靈感'
            };
            
            document.getElementById('aiPersonality').textContent = personalityTexts[personality];
            document.getElementById('hair').setAttribute('fill', hairColor);
            document.getElementById('body').setAttribute('fill', bodyColor);
        }

        function saveSettings() {
            updateAvatar();
            localStorage.setItem('aiAvatarSettings', JSON.stringify(avatarSettings));
            alert('設定已保存！');
        }

        function loadSettings() {
            const saved = localStorage.getItem('aiAvatarSettings');
            if (saved) {
                avatarSettings = JSON.parse(saved);
                
                document.getElementById('nameInput').value = avatarSettings.name;
                document.getElementById('personalitySelect').value = avatarSettings.personality;
                document.getElementById('hairColorSelect').value = avatarSettings.hairColor;
                document.getElementById('bodyColorSelect').value = avatarSettings.bodyColor;
                
                updateAvatar();
            }
        }

        async function generateAvatar() {
            const description = `Create a professional AI assistant avatar with ${avatarSettings.personality} personality`;
            
            try {
                const response = await fetch('/generate_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: description,
                        context: 'avatar'
                    })
                });

                const data = await response.json();
                if (data.success && data.image_url) {
                    document.getElementById('avatarPreview').innerHTML = 
                        `<img src="${data.image_url}" alt="AI Avatar" class="img-fluid rounded-circle" style="width: 70px; height: 70px;">`;
                    addMessage('AI頭像生成成功！', 'assistant');
                } else {
                    addMessage('頭像生成失敗：' + (data.error || '未知錯誤'), 'assistant');
                }
            } catch (error) {
                addMessage('頭像生成錯誤：' + error.message, 'assistant');
            }
        }

        async function testVoice() {
            const testText = `你好，我是${avatarSettings.name}，很高興為你服務！`;
            
            try {
                const response = await fetch('/text_to_speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: testText,
                        voice: 'alloy'
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    addMessage('語音測試失敗', 'assistant');
                }
            } catch (error) {
                addMessage('語音測試錯誤：' + error.message, 'assistant');
            }
        }

        // Quick Action Functions
        async function generateImage() {
            const prompt = window.prompt('請描述你想要的圖片:');
            if (prompt) {
                addMessage(`正在生成圖片: ${prompt}`, 'assistant');
                
                try {
                    const response = await fetch('/generate_image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    const data = await response.json();
                    if (data.success && data.image_url) {
                        addMessage(`<img src="${data.image_url}" alt="Generated Image" class="img-fluid rounded" style="max-width: 300px;">`, 'assistant');
                    }
                } catch (error) {
                    addMessage('圖片生成失敗', 'assistant');
                }
            }
        }

        function generateQR() {
            const text = window.prompt('請輸入要生成QR碼的文字:');
            if (text) {
                window.open(`/generate_qr?text=${encodeURIComponent(text)}`, '_blank');
            }
        }

        function generateDoc() {
            const type = window.prompt('選擇文件類型:\n1. Excel\n2. Word\n3. PowerPoint', '1');
            if (type) {
                const docType = type === '1' ? 'excel' : type === '2' ? 'word' : 'ppt';
                window.open(`/generate_document?type=${docType}&template=1`, '_blank');
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-update avatar settings
        document.getElementById('nameInput').addEventListener('input', updateAvatar);
        document.getElementById('personalitySelect').addEventListener('change', updateAvatar);
        document.getElementById('hairColorSelect').addEventListener('change', updateAvatar);
        document.getElementById('bodyColorSelect').addEventListener('change', updateAvatar);

        // Load settings on page load
        loadSettings();
    </script>
</body>
</html>