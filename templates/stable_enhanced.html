<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½åŠ©æ‰‹ - å…¨åŠŸèƒ½ç‰ˆ</title>
    
    <!-- Bootstrap CSS with Replit dark theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body { background-color: #1a1a1a; color: #ffffff; }
        .sidebar { width: 280px; background-color: #2a2a2a; }
        .main-content { background-color: #1e1e1e; }
        .chat-messages { height: 400px; overflow-y: auto; background-color: #2a2a2a; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
        .message.user { background-color: #007bff; text-align: right; }
        .message.assistant { background-color: #333; }
        .tool-card { background-color: #2a2a2a; border: 1px solid #444; }
        .tool-card:hover { background-color: #3a3a3a; }
        .game-canvas { background-color: #000; border: 2px solid #444; }
        .success-indicator { background-color: #28a745; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .avatar-preview { border: 2px solid #007bff; border-radius: 50%; padding: 10px; background: #f8f9fa; display: flex; justify-content: center; align-items: center; }
        .avatar-svg { border-radius: 50%; }
        .preset-avatar { border: 2px solid transparent; border-radius: 10px; padding: 10px; transition: all 0.3s ease; cursor: pointer; }
        .preset-avatar:hover { border-color: #007bff; background: rgba(0, 123, 255, 0.1); }
        .preset-preview { font-size: 2rem; margin-bottom: 5px; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h4 class="text-center mb-4">AI åŠ©æ‰‹</h4>
                    
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#chatTab">
                                <i class="fas fa-comments me-2"></i>èŠå¤©
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#toolsTab">
                                <i class="fas fa-tools me-2"></i>å·¥å…·
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#gamesTab">
                                <i class="fas fa-gamepad me-2"></i>éŠæˆ²
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#documentsTab">
                                <i class="fas fa-file-alt me-2"></i>æ–‡ä»¶
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#avatarTab">
                                <i class="fas fa-user-circle me-2"></i>AIå½¢è±¡
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="tab-content">
                    <!-- Chat Tab -->
                    <div class="tab-pane fade show active" id="chatTab">
                        <div class="container mt-4">
                            <h2>AI èŠå¤©åŠ©æ‰‹</h2>
                            <div id="chatMessages" class="chat-messages p-3 border rounded mb-3">
                                <div class="message assistant">
                                    <strong>AIåŠ©æ‰‹:</strong> ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ã€‚æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©ä½ çš„å—ï¼Ÿ
                                </div>
                            </div>
                            <div class="input-group">
                                <textarea id="messageInput" class="form-control" placeholder="è¼¸å…¥ä½ çš„è¨Šæ¯..." rows="3"></textarea>
                                <button id="sendBtn" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> ç™¼é€
                                </button>
                            </div>
                            <div class="mt-2">
                                <button id="clearHistoryBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash"></i> æ¸…é™¤æ­·å²
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tools Tab -->
                    <div class="tab-pane fade" id="toolsTab">
                        <div class="container mt-4">
                            <h2>å¯¦ç”¨å·¥å…·</h2>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-calculator fa-2x mb-3"></i>
                                            <h5>è¨ˆç®—æ©Ÿ</h5>
                                            <button class="btn btn-primary" onclick="openCalculator()">é–‹å•Ÿ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-qrcode fa-2x mb-3"></i>
                                            <h5>QRç¢¼ç”Ÿæˆå™¨</h5>
                                            <button class="btn btn-primary" onclick="openQRGenerator()">é–‹å•Ÿ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-barcode fa-2x mb-3"></i>
                                            <h5>æ¢ç¢¼ç”Ÿæˆå™¨</h5>
                                            <button class="btn btn-primary" onclick="openBarcodeGenerator()">é–‹å•Ÿ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-key fa-2x mb-3"></i>
                                            <h5>å¯†ç¢¼ç”Ÿæˆå™¨</h5>
                                            <button class="btn btn-primary" onclick="openPasswordGenerator()">é–‹å•Ÿ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-palette fa-2x mb-3"></i>
                                            <h5>CANVAè¨­è¨ˆ</h5>
                                            <button class="btn btn-primary" onclick="openDesignGenerator()">é–‹å•Ÿ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Games Tab -->
                    <div class="tab-pane fade" id="gamesTab">
                        <div class="container mt-4">
                            <h2>éŠæˆ²ä¸­å¿ƒ</h2>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-th-large fa-2x mb-3"></i>
                                            <h5>ä¿„ç¾…æ–¯æ–¹å¡Š</h5>
                                            <button class="btn btn-primary" onclick="startTetris()">é–‹å§‹éŠæˆ²</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-chess fa-2x mb-3"></i>
                                            <h5>éº»å°‡</h5>
                                            <button class="btn btn-primary" onclick="startMahjong()">é–‹å§‹éŠæˆ²</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-circle fa-2x mb-3"></i>
                                            <h5>å½ˆç éŠæˆ²</h5>
                                            <button class="btn btn-primary" onclick="startPinball()">é–‹å§‹éŠæˆ²</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Game Area -->
                            <div id="gameArea" class="mt-4" style="display: none;">
                                <div class="text-center mb-3">
                                    <h3 id="gameTitle">éŠæˆ²</h3>
                                    <button class="btn btn-secondary" onclick="closeGame()">é—œé–‰éŠæˆ²</button>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <canvas id="gameCanvas" class="game-canvas" width="400" height="400"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <div id="gameControls"></div>
                                    <div id="gameScore">åˆ†æ•¸: 0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documents Tab -->
                    <div class="tab-pane fade" id="documentsTab">
                        <div class="container mt-4">
                            <h2>æ–‡ä»¶ç”Ÿæˆ</h2>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-excel fa-2x mb-3"></i>
                                            <h5>Excel è¡¨æ ¼</h5>
                                            <button class="btn btn-primary" onclick="generateExcel()">ç”Ÿæˆ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-word fa-2x mb-3"></i>
                                            <h5>Word æ–‡ä»¶</h5>
                                            <button class="btn btn-primary" onclick="generateWord()">ç”Ÿæˆ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-powerpoint fa-2x mb-3"></i>
                                            <h5>PowerPoint</h5>
                                            <button class="btn btn-primary" onclick="generatePowerPoint()">ç”Ÿæˆ</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Avatar Tab -->
                    <div class="tab-pane fade" id="avatarTab">
                        <div class="container mt-4">
                            <h2>å€‹äººåŒ–AIåŠ©ç†å½¢è±¡</h2>
                            
                            <!-- Avatar Preview -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card tool-card text-center">
                                        <div class="card-header">
                                            <h5>AIåŠ©ç†é è¦½</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="avatarPreview" class="avatar-preview mb-3">
                                                <svg width="120" height="120" viewBox="0 0 120 120" class="avatar-svg">
                                                    <!-- Avatar Head -->
                                                    <circle cx="60" cy="45" r="25" fill="#FFE4B5" stroke="#D2B48C" stroke-width="2"/>
                                                    <!-- Eyes -->
                                                    <circle cx="52" cy="40" r="3" fill="#333" id="leftEye"/>
                                                    <circle cx="68" cy="40" r="3" fill="#333" id="rightEye"/>
                                                    <!-- Mouth -->
                                                    <path d="M 50 50 Q 60 58 70 50" stroke="#333" stroke-width="2" fill="none" id="mouth"/>
                                                    <!-- Hair -->
                                                    <path d="M 35 35 Q 60 15 85 35" fill="#8B4513" id="hair"/>
                                                    <!-- Body -->
                                                    <rect x="45" y="70" width="30" height="35" fill="#4169E1" rx="5" id="body"/>
                                                </svg>
                                            </div>
                                            <div id="avatarName" class="fw-bold">AIåŠ©æ‰‹</div>
                                            <div id="avatarPersonality" class="text-muted">å‹å–„çš„åŠ©æ‰‹</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Customization Panel -->
                                <div class="col-md-8">
                                    <div class="card tool-card">
                                        <div class="card-header">
                                            <h5>è‡ªå®šç¾©è¨­å®š</h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Name Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">AIåŠ©æ‰‹åç¨±</label>
                                                <input type="text" class="form-control" id="aiName" value="AIåŠ©æ‰‹" onchange="updateAvatar()">
                                            </div>
                                            
                                            <!-- Personality Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">å€‹æ€§ç‰¹å¾µ</label>
                                                <select class="form-select" id="aiPersonality" onchange="updateAvatar()">
                                                    <option value="friendly">å‹å–„çš„</option>
                                                    <option value="professional">å°ˆæ¥­çš„</option>
                                                    <option value="playful">æ´»æ½‘çš„</option>
                                                    <option value="wise">æ™ºæ…§çš„</option>
                                                    <option value="creative">å‰µæ„çš„</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Appearance Settings -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">é«®è‰²</label>
                                                    <select class="form-select" id="hairColor" onchange="updateAvatarAppearance()">
                                                        <option value="#8B4513">æ£•è‰²</option>
                                                        <option value="#000000">é»‘è‰²</option>
                                                        <option value="#FFD700">é‡‘è‰²</option>
                                                        <option value="#FF6347">ç´…è‰²</option>
                                                        <option value="#4169E1">è—è‰²</option>
                                                        <option value="#9370DB">ç´«è‰²</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">æœè£é¡è‰²</label>
                                                    <select class="form-select" id="bodyColor" onchange="updateAvatarAppearance()">
                                                        <option value="#4169E1">è—è‰²</option>
                                                        <option value="#FF6347">ç´…è‰²</option>
                                                        <option value="#32CD32">ç¶ è‰²</option>
                                                        <option value="#9370DB">ç´«è‰²</option>
                                                        <option value="#FF69B4">ç²‰è‰²</option>
                                                        <option value="#FFD700">é‡‘è‰²</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Voice Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">èªéŸ³é¢¨æ ¼</label>
                                                <select class="form-select" id="voiceStyle" onchange="updateAvatar()">
                                                    <option value="alloy">æ¨™æº–</option>
                                                    <option value="echo">è¿´éŸ¿</option>
                                                    <option value="fable">å¯“è¨€</option>
                                                    <option value="onyx">æ·±æ²‰</option>
                                                    <option value="nova">æ–°æ˜Ÿ</option>
                                                    <option value="shimmer">é–ƒçˆ</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Behavior Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">å°è©±é¢¨æ ¼</label>
                                                <select class="form-select" id="conversationStyle" onchange="updateAvatar()">
                                                    <option value="casual">è¼•é¬†å°è©±</option>
                                                    <option value="formal">æ­£å¼äº¤æµ</option>
                                                    <option value="detailed">è©³ç´°è§£é‡‹</option>
                                                    <option value="concise">ç°¡æ½”å›æ‡‰</option>
                                                    <option value="creative">å‰µæ„æ€ç¶­</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary" onclick="saveAvatarSettings()">
                                                    <i class="fas fa-save me-2"></i>ä¿å­˜è¨­å®š
                                                </button>
                                                <button class="btn btn-success" onclick="generateAvatarImage()">
                                                    <i class="fas fa-image me-2"></i>ç”ŸæˆAIé ­åƒ
                                                </button>
                                                <button class="btn btn-info" onclick="testVoice()">
                                                    <i class="fas fa-volume-up me-2"></i>æ¸¬è©¦èªéŸ³
                                                </button>
                                                <button class="btn btn-secondary" onclick="resetToDefault()">
                                                    <i class="fas fa-undo me-2"></i>é‡ç½®
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preset Avatars -->
                            <div class="card tool-card">
                                <div class="card-header">
                                    <h5>é è¨­å½¢è±¡</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('assistant')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">ğŸ‘©â€ğŸ’¼</div>
                                                <small>å°ˆæ¥­åŠ©ç†</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('scientist')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">ğŸ‘¨â€ğŸ”¬</div>
                                                <small>ç§‘å­¸å®¶</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('teacher')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">ğŸ‘©â€ğŸ«</div>
                                                <small>è€å¸«</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('artist')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">ğŸ‘¨â€ğŸ¨</div>
                                                <small>è—è¡“å®¶</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('robot')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">ğŸ¤–</div>
                                                <small>æ©Ÿå™¨äºº</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('wizard')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">ğŸ§™â€â™‚ï¸</div>
                                                <small>æ™ºè€…</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals and JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Basic Chat Functionality
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? 'ä½ ' : 'AIåŠ©æ‰‹'}:</strong> ${content}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                if (data.success) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`éŒ¯èª¤: ${data.error}`, 'assistant');
                }
            } catch (error) {
                addMessage(`é€£ç·šéŒ¯èª¤: ${error.message}`, 'assistant');
            }
        }

        function clearHistory() {
            chatMessages.innerHTML = '<div class="message assistant"><strong>AIåŠ©æ‰‹:</strong> æ­·å²å·²æ¸…é™¤ï¼</div>';
        }

        // Tool Functions
        function openCalculator() {
            const result = prompt('è«‹è¼¸å…¥è¨ˆç®—å¼ (ä¾‹å¦‚: 2+2):');
            if (result) {
                try {
                    const answer = eval(result);
                    alert(`çµæœ: ${answer}`);
                } catch (e) {
                    alert('è¨ˆç®—éŒ¯èª¤');
                }
            }
        }

        function openQRGenerator() {
            const text = prompt('è«‹è¼¸å…¥è¦ç”ŸæˆQRç¢¼çš„æ–‡å­—:');
            if (text) {
                const url = `/generate_qr?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        }

        function openBarcodeGenerator() {
            const text = prompt('è«‹è¼¸å…¥è¦ç”Ÿæˆæ¢ç¢¼çš„æ–‡å­—:');
            if (text) {
                const url = `/generate_barcode?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        }

        function openPasswordGenerator() {
            const length = prompt('å¯†ç¢¼é•·åº¦ (8-50):', '12');
            if (length && length >= 8 && length <= 50) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let password = '';
                for (let i = 0; i < length; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                prompt('ç”Ÿæˆçš„å¯†ç¢¼:', password);
            }
        }

        function openDesignGenerator() {
            const prompt_text = prompt('è«‹æè¿°ä½ æƒ³è¦çš„è¨­è¨ˆ (ä¾‹å¦‚: ç¾ä»£å•†æ¥­åç‰‡è¨­è¨ˆ):');
            if (prompt_text) {
                addMessage(`æ­£åœ¨ç”Ÿæˆè¨­è¨ˆ: ${prompt_text}`, 'assistant');
                // This would call the design generation API
            }
        }

        // Game Functions
        let currentGame = null;
        const gameArea = document.getElementById('gameArea');
        const gameCanvas = document.getElementById('gameCanvas');
        const gameTitle = document.getElementById('gameTitle');
        const gameScore = document.getElementById('gameScore');
        const ctx = gameCanvas.getContext('2d');

        function startTetris() {
            currentGame = 'tetris';
            gameTitle.textContent = 'ä¿„ç¾…æ–¯æ–¹å¡Š';
            gameArea.style.display = 'block';
            initTetris();
        }

        function startMahjong() {
            currentGame = 'mahjong';
            gameTitle.textContent = 'éº»å°‡';
            gameArea.style.display = 'block';
            initMahjong();
        }

        function startPinball() {
            currentGame = 'pinball';
            gameTitle.textContent = 'å½ˆç éŠæˆ²';
            gameArea.style.display = 'block';
            initPinball();
        }

        function closeGame() {
            gameArea.style.display = 'none';
            currentGame = null;
        }

        // Simple Tetris Implementation
        function initTetris() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 400, 400);
            ctx.fillStyle = '#0f0';
            ctx.fillText('Tetris - ä½¿ç”¨æ–¹å‘éµæ§åˆ¶', 10, 30);
            gameScore.textContent = 'åˆ†æ•¸: 0';
        }

        // Simple Mahjong Implementation
        function initMahjong() {
            ctx.fillStyle = '#006400';
            ctx.fillRect(0, 0, 400, 400);
            ctx.fillStyle = '#fff';
            ctx.fillText('éº»å°‡ - 4äººéŠæˆ²', 10, 30);
            // Draw simple mahjong tiles
            for (let i = 0; i < 13; i++) {
                ctx.strokeRect(20 + i * 25, 350, 20, 30);
            }
        }

        // Simple Pinball Implementation
        function initPinball() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 400, 400);
            ctx.fillStyle = '#ff0';
            ctx.fillText('å½ˆç éŠæˆ² - ç©ºç™½éµç™¼å°„, Z/Xéµæ§åˆ¶å½ˆæ¿', 10, 30);
            
            // Draw flippers
            ctx.fillStyle = '#888';
            ctx.fillRect(100, 350, 60, 10);
            ctx.fillRect(240, 350, 60, 10);
            
            // Draw ball
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(200, 200, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        // Document Generation Functions
        function generateExcel() {
            const type = prompt('é¸æ“‡é¡å‹:\n1. è²¡å‹™å ±è¡¨\n2. å“¡å·¥ç®¡ç†\n3. éŠ·å”®æ•¸æ“š\n4. åº«å­˜ç®¡ç†', '1');
            if (type) {
                window.open(`/generate_document?type=excel&template=${type}`, '_blank');
            }
        }

        function generateWord() {
            const type = prompt('é¸æ“‡é¡å‹:\n1. å•†æ¥­å ±å‘Š\n2. åˆç´„ç¯„æœ¬\n3. æœƒè­°è¨˜éŒ„\n4. å°ˆæ¡ˆææ¡ˆ', '1');
            if (type) {
                window.open(`/generate_document?type=word&template=${type}`, '_blank');
            }
        }

        function generatePowerPoint() {
            const type = prompt('é¸æ“‡é¡å‹:\n1. å•†æ¥­ææ¡ˆ\n2. å°ˆæ¡ˆå ±å‘Š\n3. åŸ¹è¨“ææ–™\n4. ç”¢å“ä»‹ç´¹', '1');
            if (type) {
                window.open(`/generate_document?type=ppt&template=${type}`, '_blank');
            }
        }

        // Initialize DOM elements
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Core Chat Functions
        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? 'ä½ ' : currentAvatarSettings.name}:</strong> ${content}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function clearHistory() {
            try {
                const response = await fetch('/clear_history', { method: 'POST' });
                if (response.ok) {
                    chatMessages.innerHTML = `<div class="message assistant">
                        <strong>${currentAvatarSettings.name}:</strong> èŠå¤©è¨˜éŒ„å·²æ¸…é™¤ï¼
                    </div>`;
                }
            } catch (error) {
                console.error('æ¸…é™¤è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        // Event Listeners
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (clearHistoryBtn) clearHistoryBtn.addEventListener('click', clearHistory);
        
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Keyboard controls for games
        document.addEventListener('keydown', (e) => {
            if (currentGame === 'pinball') {
                if (e.code === 'Space') {
                    // Launch ball
                    console.log('Ball launched');
                } else if (e.code === 'KeyZ') {
                    // Left flipper
                    console.log('Left flipper');
                } else if (e.code === 'KeyX') {
                    // Right flipper
                    console.log('Right flipper');
                }
            }
        });

        console.log('ç©©å®šç‰ˆAIåŠ©æ‰‹å·²è¼‰å…¥å®Œæˆ');

        // AI Avatar System
        let currentAvatarSettings = {
            name: 'AIåŠ©æ‰‹',
            personality: 'friendly',
            hairColor: '#8B4513',
            bodyColor: '#4169E1',
            voiceStyle: 'alloy',
            conversationStyle: 'casual'
        };

        // Avatar Management Functions
        function updateAvatar() {
            const name = document.getElementById('aiName').value;
            const personality = document.getElementById('aiPersonality').value;
            const voiceStyle = document.getElementById('voiceStyle').value;
            const conversationStyle = document.getElementById('conversationStyle').value;

            currentAvatarSettings.name = name;
            currentAvatarSettings.personality = personality;
            currentAvatarSettings.voiceStyle = voiceStyle;
            currentAvatarSettings.conversationStyle = conversationStyle;

            document.getElementById('avatarName').textContent = name;
            
            const personalityTexts = {
                'friendly': 'å‹å–„çš„åŠ©æ‰‹',
                'professional': 'å°ˆæ¥­çš„é¡§å•',
                'playful': 'æ´»æ½‘çš„å¤¥ä¼´',
                'wise': 'æ™ºæ…§çš„å°å¸«',
                'creative': 'å‰µæ„çš„éˆæ„Ÿ'
            };
            
            document.getElementById('avatarPersonality').textContent = personalityTexts[personality] || 'å‹å–„çš„åŠ©æ‰‹';
        }

        function updateAvatarAppearance() {
            const hairColor = document.getElementById('hairColor').value;
            const bodyColor = document.getElementById('bodyColor').value;

            currentAvatarSettings.hairColor = hairColor;
            currentAvatarSettings.bodyColor = bodyColor;

            document.getElementById('hair').setAttribute('fill', hairColor);
            document.getElementById('body').setAttribute('fill', bodyColor);
        }

        function saveAvatarSettings() {
            localStorage.setItem('aiAvatarSettings', JSON.stringify(currentAvatarSettings));
            alert('è¨­å®šå·²ä¿å­˜ï¼');
        }

        function loadAvatarSettings() {
            const saved = localStorage.getItem('aiAvatarSettings');
            if (saved) {
                currentAvatarSettings = JSON.parse(saved);
                
                document.getElementById('aiName').value = currentAvatarSettings.name;
                document.getElementById('aiPersonality').value = currentAvatarSettings.personality;
                document.getElementById('hairColor').value = currentAvatarSettings.hairColor;
                document.getElementById('bodyColor').value = currentAvatarSettings.bodyColor;
                document.getElementById('voiceStyle').value = currentAvatarSettings.voiceStyle;
                document.getElementById('conversationStyle').value = currentAvatarSettings.conversationStyle;
                
                updateAvatar();
                updateAvatarAppearance();
            }
        }

        async function generateAvatarImage() {
            const description = `Create a professional AI assistant avatar with ${currentAvatarSettings.personality} personality, modern style, friendly appearance`;
            
            try {
                const response = await fetch('/generate_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: description,
                        context: 'avatar'
                    })
                });

                const data = await response.json();
                if (data.success && data.image_url) {
                    const avatarPreview = document.getElementById('avatarPreview');
                    avatarPreview.innerHTML = `<img src="${data.image_url}" alt="AI Avatar" class="img-fluid rounded" style="max-width: 120px; max-height: 120px;">`;
                    alert('AIé ­åƒç”ŸæˆæˆåŠŸï¼');
                } else {
                    alert('é ­åƒç”Ÿæˆå¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('é ­åƒç”ŸæˆéŒ¯èª¤ï¼š' + error.message);
            }
        }

        async function testVoice() {
            const testText = `ä½ å¥½ï¼Œæˆ‘æ˜¯${currentAvatarSettings.name}ï¼Œå¾ˆé«˜èˆˆç‚ºä½ æœå‹™ï¼`;
            
            try {
                const response = await fetch('/text_to_speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: testText,
                        voice: currentAvatarSettings.voiceStyle
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    alert('èªéŸ³æ¸¬è©¦å¤±æ•—');
                }
            } catch (error) {
                alert('èªéŸ³æ¸¬è©¦éŒ¯èª¤ï¼š' + error.message);
            }
        }

        function resetToDefault() {
            currentAvatarSettings = {
                name: 'AIåŠ©æ‰‹',
                personality: 'friendly',
                hairColor: '#8B4513',
                bodyColor: '#4169E1',
                voiceStyle: 'alloy',
                conversationStyle: 'casual'
            };
            
            document.getElementById('aiName').value = currentAvatarSettings.name;
            document.getElementById('aiPersonality').value = currentAvatarSettings.personality;
            document.getElementById('hairColor').value = currentAvatarSettings.hairColor;
            document.getElementById('bodyColor').value = currentAvatarSettings.bodyColor;
            document.getElementById('voiceStyle').value = currentAvatarSettings.voiceStyle;
            document.getElementById('conversationStyle').value = currentAvatarSettings.conversationStyle;
            
            updateAvatar();
            updateAvatarAppearance();
            
            // Reset avatar preview to SVG
            document.getElementById('avatarPreview').innerHTML = `
                <svg width="120" height="120" viewBox="0 0 120 120" class="avatar-svg">
                    <circle cx="60" cy="45" r="25" fill="#FFE4B5" stroke="#D2B48C" stroke-width="2"/>
                    <circle cx="52" cy="40" r="3" fill="#333" id="leftEye"/>
                    <circle cx="68" cy="40" r="3" fill="#333" id="rightEye"/>
                    <path d="M 50 50 Q 60 58 70 50" stroke="#333" stroke-width="2" fill="none" id="mouth"/>
                    <path d="M 35 35 Q 60 15 85 35" fill="#8B4513" id="hair"/>
                    <rect x="45" y="70" width="30" height="35" fill="#4169E1" rx="5" id="body"/>
                </svg>
            `;
        }

        function applyPreset(preset) {
            const presets = {
                'assistant': {
                    name: 'å°ˆæ¥­åŠ©ç†',
                    personality: 'professional',
                    hairColor: '#000000',
                    bodyColor: '#4169E1',
                    voiceStyle: 'alloy',
                    conversationStyle: 'formal'
                },
                'scientist': {
                    name: 'ç§‘å­¸åšå£«',
                    personality: 'wise',
                    hairColor: '#808080',
                    bodyColor: '#FFFFFF',
                    voiceStyle: 'onyx',
                    conversationStyle: 'detailed'
                },
                'teacher': {
                    name: 'æ™ºæ…§è€å¸«',
                    personality: 'wise',
                    hairColor: '#8B4513',
                    bodyColor: '#32CD32',
                    voiceStyle: 'nova',
                    conversationStyle: 'detailed'
                },
                'artist': {
                    name: 'å‰µæ„è—è¡“å®¶',
                    personality: 'creative',
                    hairColor: '#9370DB',
                    bodyColor: '#FF69B4',
                    voiceStyle: 'shimmer',
                    conversationStyle: 'creative'
                },
                'robot': {
                    name: 'æ©Ÿå™¨åŠ©æ‰‹',
                    personality: 'professional',
                    hairColor: '#C0C0C0',
                    bodyColor: '#708090',
                    voiceStyle: 'echo',
                    conversationStyle: 'concise'
                },
                'wizard': {
                    name: 'æ™ºæ…§å°å¸«',
                    personality: 'wise',
                    hairColor: '#FFFFFF',
                    bodyColor: '#9370DB',
                    voiceStyle: 'fable',
                    conversationStyle: 'detailed'
                }
            };

            if (presets[preset]) {
                currentAvatarSettings = { ...presets[preset] };
                
                document.getElementById('aiName').value = currentAvatarSettings.name;
                document.getElementById('aiPersonality').value = currentAvatarSettings.personality;
                document.getElementById('hairColor').value = currentAvatarSettings.hairColor;
                document.getElementById('bodyColor').value = currentAvatarSettings.bodyColor;
                document.getElementById('voiceStyle').value = currentAvatarSettings.voiceStyle;
                document.getElementById('conversationStyle').value = currentAvatarSettings.conversationStyle;
                
                updateAvatar();
                updateAvatarAppearance();
            }
        }

        // Enhanced sendMessage function with avatar support
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        avatar_settings: currentAvatarSettings
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`éŒ¯èª¤: ${data.error}`, 'assistant');
                }
            } catch (error) {
                addMessage(`é€£ç·šéŒ¯èª¤: ${error.message}`, 'assistant');
            }
        }

        // Load saved settings on page load
        loadAvatarSettings();
    </script>
</body>
</html>