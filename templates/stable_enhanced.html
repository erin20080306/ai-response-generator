<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助手 - 全功能版</title>
    
    <!-- Bootstrap CSS with Replit dark theme -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body { background-color: #1a1a1a; color: #ffffff; }
        .sidebar { width: 280px; background-color: #2a2a2a; }
        .main-content { background-color: #1e1e1e; }
        .chat-messages { height: 400px; overflow-y: auto; background-color: #2a2a2a; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
        .message.user { background-color: #007bff; text-align: right; }
        .message.assistant { background-color: #333; }
        .tool-card { background-color: #2a2a2a; border: 1px solid #444; }
        .tool-card:hover { background-color: #3a3a3a; }
        .game-canvas { background-color: #000; border: 2px solid #444; }
        .success-indicator { background-color: #28a745; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .avatar-preview { border: 2px solid #007bff; border-radius: 50%; padding: 10px; background: #f8f9fa; display: flex; justify-content: center; align-items: center; }
        .avatar-svg { border-radius: 50%; }
        .preset-avatar { border: 2px solid transparent; border-radius: 10px; padding: 10px; transition: all 0.3s ease; cursor: pointer; }
        .preset-avatar:hover { border-color: #007bff; background: rgba(0, 123, 255, 0.1); }
        .preset-preview { font-size: 2rem; margin-bottom: 5px; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h4 class="text-center mb-4">AI 助手</h4>
                    
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#chatTab">
                                <i class="fas fa-comments me-2"></i>聊天
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#toolsTab">
                                <i class="fas fa-tools me-2"></i>工具
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#gamesTab">
                                <i class="fas fa-gamepad me-2"></i>遊戲
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#documentsTab">
                                <i class="fas fa-file-alt me-2"></i>文件
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#avatarTab">
                                <i class="fas fa-user-circle me-2"></i>AI形象
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="tab-content">
                    <!-- Chat Tab -->
                    <div class="tab-pane fade show active" id="chatTab">
                        <div class="container mt-4">
                            <h2>AI 聊天助手</h2>
                            <div id="chatMessages" class="chat-messages p-3 border rounded mb-3">
                                <div class="message assistant">
                                    <strong>AI助手:</strong> 你好！我是你的AI助手。有什麼可以幫助你的嗎？
                                </div>
                            </div>
                            <div class="input-group">
                                <textarea id="messageInput" class="form-control" placeholder="輸入你的訊息..." rows="3"></textarea>
                                <button id="sendBtn" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> 發送
                                </button>
                            </div>
                            <div class="mt-2">
                                <button id="clearHistoryBtn" class="btn btn-secondary">
                                    <i class="fas fa-trash"></i> 清除歷史
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tools Tab -->
                    <div class="tab-pane fade" id="toolsTab">
                        <div class="container mt-4">
                            <h2>實用工具</h2>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-calculator fa-2x mb-3"></i>
                                            <h5>計算機</h5>
                                            <button class="btn btn-primary" onclick="openCalculator()">開啟</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-qrcode fa-2x mb-3"></i>
                                            <h5>QR碼生成器</h5>
                                            <button class="btn btn-primary" onclick="openQRGenerator()">開啟</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-barcode fa-2x mb-3"></i>
                                            <h5>條碼生成器</h5>
                                            <button class="btn btn-primary" onclick="openBarcodeGenerator()">開啟</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-key fa-2x mb-3"></i>
                                            <h5>密碼生成器</h5>
                                            <button class="btn btn-primary" onclick="openPasswordGenerator()">開啟</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-palette fa-2x mb-3"></i>
                                            <h5>CANVA設計</h5>
                                            <button class="btn btn-primary" onclick="openDesignGenerator()">開啟</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Games Tab -->
                    <div class="tab-pane fade" id="gamesTab">
                        <div class="container mt-4">
                            <h2>遊戲中心</h2>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-th-large fa-2x mb-3"></i>
                                            <h5>俄羅斯方塊</h5>
                                            <button class="btn btn-primary" onclick="startTetris()">開始遊戲</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-chess fa-2x mb-3"></i>
                                            <h5>麻將</h5>
                                            <button class="btn btn-primary" onclick="startMahjong()">開始遊戲</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-circle fa-2x mb-3"></i>
                                            <h5>彈珠遊戲</h5>
                                            <button class="btn btn-primary" onclick="startPinball()">開始遊戲</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Game Area -->
                            <div id="gameArea" class="mt-4" style="display: none;">
                                <div class="text-center mb-3">
                                    <h3 id="gameTitle">遊戲</h3>
                                    <button class="btn btn-secondary" onclick="closeGame()">關閉遊戲</button>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <canvas id="gameCanvas" class="game-canvas" width="400" height="400"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <div id="gameControls"></div>
                                    <div id="gameScore">分數: 0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documents Tab -->
                    <div class="tab-pane fade" id="documentsTab">
                        <div class="container mt-4">
                            <h2>文件生成</h2>
                            <div class="row">
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-excel fa-2x mb-3"></i>
                                            <h5>Excel 表格</h5>
                                            <button class="btn btn-primary" onclick="generateExcel()">生成</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-word fa-2x mb-3"></i>
                                            <h5>Word 文件</h5>
                                            <button class="btn btn-primary" onclick="generateWord()">生成</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card tool-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-powerpoint fa-2x mb-3"></i>
                                            <h5>PowerPoint</h5>
                                            <button class="btn btn-primary" onclick="generatePowerPoint()">生成</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Avatar Tab -->
                    <div class="tab-pane fade" id="avatarTab">
                        <div class="container mt-4">
                            <h2>個人化AI助理形象</h2>
                            
                            <!-- Avatar Preview -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card tool-card text-center">
                                        <div class="card-header">
                                            <h5>AI助理預覽</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="avatarPreview" class="avatar-preview mb-3">
                                                <svg width="120" height="120" viewBox="0 0 120 120" class="avatar-svg">
                                                    <!-- Avatar Head -->
                                                    <circle cx="60" cy="45" r="25" fill="#FFE4B5" stroke="#D2B48C" stroke-width="2"/>
                                                    <!-- Eyes -->
                                                    <circle cx="52" cy="40" r="3" fill="#333" id="leftEye"/>
                                                    <circle cx="68" cy="40" r="3" fill="#333" id="rightEye"/>
                                                    <!-- Mouth -->
                                                    <path d="M 50 50 Q 60 58 70 50" stroke="#333" stroke-width="2" fill="none" id="mouth"/>
                                                    <!-- Hair -->
                                                    <path d="M 35 35 Q 60 15 85 35" fill="#8B4513" id="hair"/>
                                                    <!-- Body -->
                                                    <rect x="45" y="70" width="30" height="35" fill="#4169E1" rx="5" id="body"/>
                                                </svg>
                                            </div>
                                            <div id="avatarName" class="fw-bold">AI助手</div>
                                            <div id="avatarPersonality" class="text-muted">友善的助手</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Customization Panel -->
                                <div class="col-md-8">
                                    <div class="card tool-card">
                                        <div class="card-header">
                                            <h5>自定義設定</h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Name Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">AI助手名稱</label>
                                                <input type="text" class="form-control" id="aiName" value="AI助手" onchange="updateAvatar()">
                                            </div>
                                            
                                            <!-- Personality Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">個性特徵</label>
                                                <select class="form-select" id="aiPersonality" onchange="updateAvatar()">
                                                    <option value="friendly">友善的</option>
                                                    <option value="professional">專業的</option>
                                                    <option value="playful">活潑的</option>
                                                    <option value="wise">智慧的</option>
                                                    <option value="creative">創意的</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Appearance Settings -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">髮色</label>
                                                    <select class="form-select" id="hairColor" onchange="updateAvatarAppearance()">
                                                        <option value="#8B4513">棕色</option>
                                                        <option value="#000000">黑色</option>
                                                        <option value="#FFD700">金色</option>
                                                        <option value="#FF6347">紅色</option>
                                                        <option value="#4169E1">藍色</option>
                                                        <option value="#9370DB">紫色</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">服裝顏色</label>
                                                    <select class="form-select" id="bodyColor" onchange="updateAvatarAppearance()">
                                                        <option value="#4169E1">藍色</option>
                                                        <option value="#FF6347">紅色</option>
                                                        <option value="#32CD32">綠色</option>
                                                        <option value="#9370DB">紫色</option>
                                                        <option value="#FF69B4">粉色</option>
                                                        <option value="#FFD700">金色</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Voice Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">語音風格</label>
                                                <select class="form-select" id="voiceStyle" onchange="updateAvatar()">
                                                    <option value="alloy">標準</option>
                                                    <option value="echo">迴響</option>
                                                    <option value="fable">寓言</option>
                                                    <option value="onyx">深沉</option>
                                                    <option value="nova">新星</option>
                                                    <option value="shimmer">閃爍</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Behavior Settings -->
                                            <div class="mb-3">
                                                <label class="form-label">對話風格</label>
                                                <select class="form-select" id="conversationStyle" onchange="updateAvatar()">
                                                    <option value="casual">輕鬆對話</option>
                                                    <option value="formal">正式交流</option>
                                                    <option value="detailed">詳細解釋</option>
                                                    <option value="concise">簡潔回應</option>
                                                    <option value="creative">創意思維</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary" onclick="saveAvatarSettings()">
                                                    <i class="fas fa-save me-2"></i>保存設定
                                                </button>
                                                <button class="btn btn-success" onclick="generateAvatarImage()">
                                                    <i class="fas fa-image me-2"></i>生成AI頭像
                                                </button>
                                                <button class="btn btn-info" onclick="testVoice()">
                                                    <i class="fas fa-volume-up me-2"></i>測試語音
                                                </button>
                                                <button class="btn btn-secondary" onclick="resetToDefault()">
                                                    <i class="fas fa-undo me-2"></i>重置
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preset Avatars -->
                            <div class="card tool-card">
                                <div class="card-header">
                                    <h5>預設形象</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('assistant')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">👩‍💼</div>
                                                <small>專業助理</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('scientist')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">👨‍🔬</div>
                                                <small>科學家</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('teacher')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">👩‍🏫</div>
                                                <small>老師</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('artist')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">👨‍🎨</div>
                                                <small>藝術家</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('robot')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">🤖</div>
                                                <small>機器人</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3" onclick="applyPreset('wizard')">
                                            <div class="preset-avatar text-center cursor-pointer">
                                                <div class="preset-preview mb-2">🧙‍♂️</div>
                                                <small>智者</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals and JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Basic Chat Functionality
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? '你' : 'AI助手'}:</strong> ${content}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                if (data.success) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`錯誤: ${data.error}`, 'assistant');
                }
            } catch (error) {
                addMessage(`連線錯誤: ${error.message}`, 'assistant');
            }
        }

        function clearHistory() {
            chatMessages.innerHTML = '<div class="message assistant"><strong>AI助手:</strong> 歷史已清除！</div>';
        }

        // Tool Functions
        function openCalculator() {
            const result = prompt('請輸入計算式 (例如: 2+2):');
            if (result) {
                try {
                    const answer = eval(result);
                    alert(`結果: ${answer}`);
                } catch (e) {
                    alert('計算錯誤');
                }
            }
        }

        function openQRGenerator() {
            const text = prompt('請輸入要生成QR碼的文字:');
            if (text) {
                const url = `/generate_qr?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        }

        function openBarcodeGenerator() {
            const text = prompt('請輸入要生成條碼的文字:');
            if (text) {
                const url = `/generate_barcode?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
            }
        }

        function openPasswordGenerator() {
            const length = prompt('密碼長度 (8-50):', '12');
            if (length && length >= 8 && length <= 50) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let password = '';
                for (let i = 0; i < length; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                prompt('生成的密碼:', password);
            }
        }

        function openDesignGenerator() {
            const prompt_text = prompt('請描述你想要的設計 (例如: 現代商業名片設計):');
            if (prompt_text) {
                addMessage(`正在生成設計: ${prompt_text}`, 'assistant');
                // This would call the design generation API
            }
        }

        // Game Functions
        let currentGame = null;
        const gameArea = document.getElementById('gameArea');
        const gameCanvas = document.getElementById('gameCanvas');
        const gameTitle = document.getElementById('gameTitle');
        const gameScore = document.getElementById('gameScore');
        const ctx = gameCanvas.getContext('2d');

        function startTetris() {
            currentGame = 'tetris';
            gameTitle.textContent = '俄羅斯方塊';
            gameArea.style.display = 'block';
            initTetris();
        }

        function startMahjong() {
            currentGame = 'mahjong';
            gameTitle.textContent = '麻將';
            gameArea.style.display = 'block';
            initMahjong();
        }

        function startPinball() {
            currentGame = 'pinball';
            gameTitle.textContent = '彈珠遊戲';
            gameArea.style.display = 'block';
            initPinball();
        }

        function closeGame() {
            gameArea.style.display = 'none';
            currentGame = null;
        }

        // Simple Tetris Implementation
        function initTetris() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 400, 400);
            ctx.fillStyle = '#0f0';
            ctx.fillText('Tetris - 使用方向鍵控制', 10, 30);
            gameScore.textContent = '分數: 0';
        }

        // Simple Mahjong Implementation
        function initMahjong() {
            ctx.fillStyle = '#006400';
            ctx.fillRect(0, 0, 400, 400);
            ctx.fillStyle = '#fff';
            ctx.fillText('麻將 - 4人遊戲', 10, 30);
            // Draw simple mahjong tiles
            for (let i = 0; i < 13; i++) {
                ctx.strokeRect(20 + i * 25, 350, 20, 30);
            }
        }

        // Simple Pinball Implementation
        function initPinball() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 400, 400);
            ctx.fillStyle = '#ff0';
            ctx.fillText('彈珠遊戲 - 空白鍵發射, Z/X鍵控制彈板', 10, 30);
            
            // Draw flippers
            ctx.fillStyle = '#888';
            ctx.fillRect(100, 350, 60, 10);
            ctx.fillRect(240, 350, 60, 10);
            
            // Draw ball
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(200, 200, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        // Document Generation Functions
        function generateExcel() {
            const type = prompt('選擇類型:\n1. 財務報表\n2. 員工管理\n3. 銷售數據\n4. 庫存管理', '1');
            if (type) {
                window.open(`/generate_document?type=excel&template=${type}`, '_blank');
            }
        }

        function generateWord() {
            const type = prompt('選擇類型:\n1. 商業報告\n2. 合約範本\n3. 會議記錄\n4. 專案提案', '1');
            if (type) {
                window.open(`/generate_document?type=word&template=${type}`, '_blank');
            }
        }

        function generatePowerPoint() {
            const type = prompt('選擇類型:\n1. 商業提案\n2. 專案報告\n3. 培訓材料\n4. 產品介紹', '1');
            if (type) {
                window.open(`/generate_document?type=ppt&template=${type}`, '_blank');
            }
        }

        // Initialize DOM elements
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Core Chat Functions
        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? '你' : currentAvatarSettings.name}:</strong> ${content}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function clearHistory() {
            try {
                const response = await fetch('/clear_history', { method: 'POST' });
                if (response.ok) {
                    chatMessages.innerHTML = `<div class="message assistant">
                        <strong>${currentAvatarSettings.name}:</strong> 聊天記錄已清除！
                    </div>`;
                }
            } catch (error) {
                console.error('清除記錄失敗:', error);
            }
        }

        // Event Listeners
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (clearHistoryBtn) clearHistoryBtn.addEventListener('click', clearHistory);
        
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Keyboard controls for games
        document.addEventListener('keydown', (e) => {
            if (currentGame === 'pinball') {
                if (e.code === 'Space') {
                    // Launch ball
                    console.log('Ball launched');
                } else if (e.code === 'KeyZ') {
                    // Left flipper
                    console.log('Left flipper');
                } else if (e.code === 'KeyX') {
                    // Right flipper
                    console.log('Right flipper');
                }
            }
        });

        console.log('穩定版AI助手已載入完成');

        // AI Avatar System
        let currentAvatarSettings = {
            name: 'AI助手',
            personality: 'friendly',
            hairColor: '#8B4513',
            bodyColor: '#4169E1',
            voiceStyle: 'alloy',
            conversationStyle: 'casual'
        };

        // Avatar Management Functions
        function updateAvatar() {
            const name = document.getElementById('aiName').value;
            const personality = document.getElementById('aiPersonality').value;
            const voiceStyle = document.getElementById('voiceStyle').value;
            const conversationStyle = document.getElementById('conversationStyle').value;

            currentAvatarSettings.name = name;
            currentAvatarSettings.personality = personality;
            currentAvatarSettings.voiceStyle = voiceStyle;
            currentAvatarSettings.conversationStyle = conversationStyle;

            document.getElementById('avatarName').textContent = name;
            
            const personalityTexts = {
                'friendly': '友善的助手',
                'professional': '專業的顧問',
                'playful': '活潑的夥伴',
                'wise': '智慧的導師',
                'creative': '創意的靈感'
            };
            
            document.getElementById('avatarPersonality').textContent = personalityTexts[personality] || '友善的助手';
        }

        function updateAvatarAppearance() {
            const hairColor = document.getElementById('hairColor').value;
            const bodyColor = document.getElementById('bodyColor').value;

            currentAvatarSettings.hairColor = hairColor;
            currentAvatarSettings.bodyColor = bodyColor;

            document.getElementById('hair').setAttribute('fill', hairColor);
            document.getElementById('body').setAttribute('fill', bodyColor);
        }

        function saveAvatarSettings() {
            localStorage.setItem('aiAvatarSettings', JSON.stringify(currentAvatarSettings));
            alert('設定已保存！');
        }

        function loadAvatarSettings() {
            const saved = localStorage.getItem('aiAvatarSettings');
            if (saved) {
                currentAvatarSettings = JSON.parse(saved);
                
                document.getElementById('aiName').value = currentAvatarSettings.name;
                document.getElementById('aiPersonality').value = currentAvatarSettings.personality;
                document.getElementById('hairColor').value = currentAvatarSettings.hairColor;
                document.getElementById('bodyColor').value = currentAvatarSettings.bodyColor;
                document.getElementById('voiceStyle').value = currentAvatarSettings.voiceStyle;
                document.getElementById('conversationStyle').value = currentAvatarSettings.conversationStyle;
                
                updateAvatar();
                updateAvatarAppearance();
            }
        }

        async function generateAvatarImage() {
            const description = `Create a professional AI assistant avatar with ${currentAvatarSettings.personality} personality, modern style, friendly appearance`;
            
            try {
                const response = await fetch('/generate_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: description,
                        context: 'avatar'
                    })
                });

                const data = await response.json();
                if (data.success && data.image_url) {
                    const avatarPreview = document.getElementById('avatarPreview');
                    avatarPreview.innerHTML = `<img src="${data.image_url}" alt="AI Avatar" class="img-fluid rounded" style="max-width: 120px; max-height: 120px;">`;
                    alert('AI頭像生成成功！');
                } else {
                    alert('頭像生成失敗：' + (data.error || '未知錯誤'));
                }
            } catch (error) {
                alert('頭像生成錯誤：' + error.message);
            }
        }

        async function testVoice() {
            const testText = `你好，我是${currentAvatarSettings.name}，很高興為你服務！`;
            
            try {
                const response = await fetch('/text_to_speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: testText,
                        voice: currentAvatarSettings.voiceStyle
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    alert('語音測試失敗');
                }
            } catch (error) {
                alert('語音測試錯誤：' + error.message);
            }
        }

        function resetToDefault() {
            currentAvatarSettings = {
                name: 'AI助手',
                personality: 'friendly',
                hairColor: '#8B4513',
                bodyColor: '#4169E1',
                voiceStyle: 'alloy',
                conversationStyle: 'casual'
            };
            
            document.getElementById('aiName').value = currentAvatarSettings.name;
            document.getElementById('aiPersonality').value = currentAvatarSettings.personality;
            document.getElementById('hairColor').value = currentAvatarSettings.hairColor;
            document.getElementById('bodyColor').value = currentAvatarSettings.bodyColor;
            document.getElementById('voiceStyle').value = currentAvatarSettings.voiceStyle;
            document.getElementById('conversationStyle').value = currentAvatarSettings.conversationStyle;
            
            updateAvatar();
            updateAvatarAppearance();
            
            // Reset avatar preview to SVG
            document.getElementById('avatarPreview').innerHTML = `
                <svg width="120" height="120" viewBox="0 0 120 120" class="avatar-svg">
                    <circle cx="60" cy="45" r="25" fill="#FFE4B5" stroke="#D2B48C" stroke-width="2"/>
                    <circle cx="52" cy="40" r="3" fill="#333" id="leftEye"/>
                    <circle cx="68" cy="40" r="3" fill="#333" id="rightEye"/>
                    <path d="M 50 50 Q 60 58 70 50" stroke="#333" stroke-width="2" fill="none" id="mouth"/>
                    <path d="M 35 35 Q 60 15 85 35" fill="#8B4513" id="hair"/>
                    <rect x="45" y="70" width="30" height="35" fill="#4169E1" rx="5" id="body"/>
                </svg>
            `;
        }

        function applyPreset(preset) {
            const presets = {
                'assistant': {
                    name: '專業助理',
                    personality: 'professional',
                    hairColor: '#000000',
                    bodyColor: '#4169E1',
                    voiceStyle: 'alloy',
                    conversationStyle: 'formal'
                },
                'scientist': {
                    name: '科學博士',
                    personality: 'wise',
                    hairColor: '#808080',
                    bodyColor: '#FFFFFF',
                    voiceStyle: 'onyx',
                    conversationStyle: 'detailed'
                },
                'teacher': {
                    name: '智慧老師',
                    personality: 'wise',
                    hairColor: '#8B4513',
                    bodyColor: '#32CD32',
                    voiceStyle: 'nova',
                    conversationStyle: 'detailed'
                },
                'artist': {
                    name: '創意藝術家',
                    personality: 'creative',
                    hairColor: '#9370DB',
                    bodyColor: '#FF69B4',
                    voiceStyle: 'shimmer',
                    conversationStyle: 'creative'
                },
                'robot': {
                    name: '機器助手',
                    personality: 'professional',
                    hairColor: '#C0C0C0',
                    bodyColor: '#708090',
                    voiceStyle: 'echo',
                    conversationStyle: 'concise'
                },
                'wizard': {
                    name: '智慧導師',
                    personality: 'wise',
                    hairColor: '#FFFFFF',
                    bodyColor: '#9370DB',
                    voiceStyle: 'fable',
                    conversationStyle: 'detailed'
                }
            };

            if (presets[preset]) {
                currentAvatarSettings = { ...presets[preset] };
                
                document.getElementById('aiName').value = currentAvatarSettings.name;
                document.getElementById('aiPersonality').value = currentAvatarSettings.personality;
                document.getElementById('hairColor').value = currentAvatarSettings.hairColor;
                document.getElementById('bodyColor').value = currentAvatarSettings.bodyColor;
                document.getElementById('voiceStyle').value = currentAvatarSettings.voiceStyle;
                document.getElementById('conversationStyle').value = currentAvatarSettings.conversationStyle;
                
                updateAvatar();
                updateAvatarAppearance();
            }
        }

        // Enhanced sendMessage function with avatar support
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message,
                        avatar_settings: currentAvatarSettings
                    })
                });

                const data = await response.json();
                if (data.success) {
                    addMessage(data.response, 'assistant');
                } else {
                    addMessage(`錯誤: ${data.error}`, 'assistant');
                }
            } catch (error) {
                addMessage(`連線錯誤: ${error.message}`, 'assistant');
            }
        }

        // Load saved settings on page load
        loadAvatarSettings();
    </script>
</body>
</html>