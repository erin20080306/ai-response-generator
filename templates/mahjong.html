<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻將遊戲</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #0F5132;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
        }
        .mahjong-table {
            width: 800px;
            height: 600px;
            margin: 20px auto;
            position: relative;
            background: #0F5132;
            border: 3px solid #333;
            border-radius: 10px;
        }
        .mahjong-tile {
            background: linear-gradient(145deg, #fafafa, #f0f0f0);
            border: 2px solid #666;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            color: #000;
            box-shadow: 3px 3px 6px rgba(0,0,0,0.4), inset 1px 1px 2px rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }
        .mahjong-tile::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: rgba(255,255,255,0.3);
        }
        .mahjong-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .player-tile {
            width: 40px;
            height: 50px;
            font-size: 18px;
            margin: 2px;
            color: #000;
            font-weight: bold;
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
        }
        
        /* 萬字牌樣式 - 紅色字體 */
        .tile-wan {
            color: #dc3545;
            font-size: 16px;
            font-weight: 900;
            text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.3);
            background: linear-gradient(to bottom, #ffeaea 0%, #fff5f5 100%);
            position: relative;
        }
        .tile-wan::before {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: linear-gradient(to right, #dc3545, #e74c3c);
            border-radius: 1px;
        }
        
        /* 條子牌樣式 - 綠色竹子圖案 */
        .tile-tiao {
            background: linear-gradient(to bottom, #e8f5e8 0%, #f0f8f0 100%);
            color: #2d5a2d;
            font-size: 0;
            position: relative;
        }
        .tile-tiao::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-image: repeating-linear-gradient(
                0deg,
                #28a745 0px,
                #28a745 2px,
                #20c997 2px,
                #20c997 4px
            );
            border-radius: 2px;
        }
        
        /* 筒子牌樣式 - 圓形圖案 */
        .tile-tong {
            background: linear-gradient(to bottom, #e3f2fd 0%, #f1f8ff 100%);
            color: #1976d2;
            font-size: 0;
            position: relative;
        }
        .tile-tong::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid #1976d2;
            border-radius: 50%;
            background: #fff;
        }
        
        /* 風牌樣式 - 傳統字體 */
        .tile-feng {
            color: #6c757d;
            font-size: 18px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        }
        
        /* 箭牌樣式 */
        .tile-zhong {
            color: #dc3545;
            font-size: 18px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .tile-fa {
            color: #28a745;
            font-size: 18px;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .tile-bai {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 2px solid #007bff;
            color: #007bff;
            font-size: 18px;
            font-weight: 900;
        }
        
        /* 花牌樣式 */
        .tile-hua {
            background: linear-gradient(145deg, #fff3cd, #ffeaa7);
            color: #856404;
            font-weight: 900;
            border: 2px solid #ffc107;
        }
        .computer-tile {
            background: #4a90e2;
            border: 1px solid #333;
        }
        .discarded-tile {
            width: 32px;
            height: 42px;
            font-size: 14px;
            margin: 1px;
            color: #000;
            font-weight: bold;
        }
        .melded-tile {
            width: 28px;
            height: 38px;
            font-size: 13px;
            background: #ffffcc;
            margin: 1px;
            color: #000;
            font-weight: bold;
        }
        .player-bottom {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .player-right {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
        }
        .player-top {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .player-left {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
        }
        .table-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            height: 250px;
            border: 2px solid #666;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            padding: 10px;
        }
        .player-info {
            color: #fff;
            font-size: 14px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.7);
            padding: 4px 10px;
            border-radius: 5px;
        }
        .action-prompt {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: none;
        }
        .game-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="mahjong-table">
                    <!-- 遊戲狀態顯示 -->
                    <div class="game-status">
                        <div>剩餘牌張: <span id="remainingTiles">144</span></div>
                        <div>當前玩家: <span id="currentPlayer">你</span></div>
                    </div>
                    
                    <!-- 桌面中央區域 - 顯示打出的牌 -->
                    <div class="table-center">
                        <div style="text-align: center; color: #fff; margin-bottom: 10px;">打出的牌</div>
                        <div id="discardedTiles" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- 玩家位置 - 底部(你) -->
                    <div class="player-bottom">
                        <div class="player-info">
                            <span>你 (25000分)</span>
                        </div>
                        <div id="playerTiles" style="display: flex; gap: 2px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px;"></div>
                        <div id="playerMelded" style="display: flex; gap: 8px; justify-content: center;"></div>
                    </div>
                    
                    <!-- 電腦AI玩家 - 右側 -->
                    <div class="player-right">
                        <div class="player-info">
                            <span>電腦1 (25000分)</span>
                        </div>
                        <div id="computerTiles1" style="display: flex; flex-direction: column; gap: 2px; align-items: center;"></div>
                        <div id="computerMelded1" style="display: flex; flex-direction: column; gap: 4px; align-items: center; margin-top: 8px;"></div>
                    </div>
                    
                    <!-- 電腦AI玩家 - 頂部 -->
                    <div class="player-top">
                        <div class="player-info">
                            <span>電腦2 (25000分)</span>
                        </div>
                        <div id="computerTiles2" style="display: flex; gap: 2px; justify-content: center;"></div>
                        <div id="computerMelded2" style="display: flex; gap: 4px; justify-content: center; margin-top: 8px;"></div>
                    </div>
                    
                    <!-- 電腦AI玩家 - 左側 -->
                    <div class="player-left">
                        <div class="player-info">
                            <span>電腦3 (25000分)</span>
                        </div>
                        <div id="computerTiles3" style="display: flex; flex-direction: column; gap: 2px; align-items: center;"></div>
                        <div id="computerMelded3" style="display: flex; flex-direction: column; gap: 4px; align-items: center; margin-top: 8px;"></div>
                    </div>
                    
                    <!-- 動作提示面板 -->
                    <div class="action-prompt" id="actionPrompt">
                        <div style="font-size: 16px; margin-bottom: 10px; text-align: center;">可選動作：</div>
                        <div class="action-buttons" style="display: flex; gap: 10px;">
                            <button onclick="executeAction('chi')" class="btn btn-success btn-sm">吃</button>
                            <button onclick="executeAction('pong')" class="btn btn-warning btn-sm">碰</button>
                            <button onclick="executeAction('kong')" class="btn btn-danger btn-sm">槓</button>
                            <button onclick="executeAction('hu')" class="btn btn-primary btn-sm">胡</button>
                            <button onclick="passAction()" class="btn btn-secondary btn-sm">過</button>
                        </div>
                    </div>
                </div>
                
                <!-- 遊戲控制面板 -->
                <div class="text-center mt-3">
                    <button onclick="startGame()" class="btn btn-primary btn-lg me-3">開始遊戲</button>
                    <button onclick="drawTile()" class="btn btn-success me-3" id="drawBtn" disabled>摸牌</button>
                    <button onclick="window.location.href='/'" class="btn btn-secondary">返回首頁</button>
                </div>
                
                <!-- 遊戲訊息顯示 -->
                <div class="alert alert-info mt-3" id="gameMessage" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let gameState = null;
        let currentPlayerTurn = 0;
        let waitingForAction = false;

        // 開始遊戲
        async function startGame() {
            try {
                const response = await fetch('/mahjong/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    gameState = data;
                    renderPlayerHand(data.player_hand);
                    renderComputerHands(data.hand_count);
                    updateGameStatus(data.remaining_tiles, '你');
                    document.getElementById('drawBtn').disabled = false;
                    showMessage('遊戲開始！請摸牌。', 'success');
                } else {
                    showMessage('遊戲開始失敗：' + data.error, 'danger');
                }
            } catch (error) {
                showMessage('網絡錯誤：' + error.message, 'danger');
            }
        }

        // 摸牌
        async function drawTile() {
            try {
                const response = await fetch('/mahjong/draw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    renderPlayerHand(data.player_hand);
                    updateGameStatus(data.remaining_tiles, '你');
                    showMessage('摸到：' + data.new_tile + '，請選擇要打出的牌。', 'info');
                    waitingForAction = true;
                    document.getElementById('drawBtn').disabled = true;
                } else {
                    showMessage('摸牌失敗：' + data.error, 'danger');
                }
            } catch (error) {
                showMessage('網絡錯誤：' + error.message, 'danger');
            }
        }

        // 打牌
        async function discardTile(tileIndex) {
            if (!waitingForAction) return;
            
            try {
                const response = await fetch('/mahjong/discard', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tile_index: tileIndex })
                });
                
                const data = await response.json();
                if (data.success) {
                    renderPlayerHand(data.player_hand);
                    renderDiscardedTiles(data.discarded_tiles);
                    showMessage('你打出：' + data.discarded_tile, 'info');
                    waitingForAction = false;
                    
                    // 開始電腦回合
                    setTimeout(computerTurn, 1000);
                } else {
                    showMessage('打牌失敗：' + data.error, 'danger');
                }
            } catch (error) {
                showMessage('網絡錯誤：' + error.message, 'danger');
            }
        }

        // 電腦回合
        async function computerTurn() {
            try {
                const response = await fetch('/mahjong/computer_turn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    renderDiscardedTiles(data.discarded_tiles);
                    renderComputerHands(data.hand_counts);
                    updateGameStatus(data.remaining_tiles, getPlayerName(data.current_player));
                    showMessage('電腦' + (data.computer_player + 1) + '打出：' + data.discarded_tile, 'info');
                    
                    // 檢查是否有可用動作
                    if (data.available_actions && data.available_actions.length > 0) {
                        showActionPrompt(data.available_actions, data.discarded_tile);
                    } else if (data.current_player === 0) {
                        // 輪到玩家
                        document.getElementById('drawBtn').disabled = false;
                        showMessage('輪到你了，請摸牌。', 'success');
                    } else {
                        // 繼續電腦回合
                        setTimeout(computerTurn, 1500);
                    }
                } else {
                    showMessage('電腦回合錯誤：' + data.error, 'danger');
                }
            } catch (error) {
                showMessage('網絡錯誤：' + error.message, 'danger');
            }
        }

        // 執行動作
        async function executeAction(action) {
            try {
                const response = await fetch('/mahjong/action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: action })
                });
                
                const data = await response.json();
                if (data.success) {
                    hideActionPrompt();
                    
                    if (data.game_over) {
                        showMessage(data.message, 'success');
                        document.getElementById('drawBtn').disabled = true;
                    } else {
                        renderPlayerHand(data.player_hand);
                        renderPlayerMelded(data.player_melded);
                        renderDiscardedTiles(data.discarded_tiles);
                        showMessage(action + '成功！請選擇要打出的牌。', 'success');
                        waitingForAction = true;
                    }
                } else {
                    showMessage('動作失敗：' + data.error, 'danger');
                }
            } catch (error) {
                showMessage('網絡錯誤：' + error.message, 'danger');
            }
        }

        // 過牌
        function passAction() {
            hideActionPrompt();
            setTimeout(computerTurn, 500);
        }

        // 渲染玩家手牌
        function renderPlayerHand(hand) {
            const container = document.getElementById('playerTiles');
            if (!container) return;
            
            container.innerHTML = '';
            
            hand.forEach((tile, index) => {
                const tileElement = document.createElement('div');
                tileElement.className = 'mahjong-tile player-tile ' + getTileClass(tile);
                
                // 對於條子和筒子牌，創建圖案；其他牌顯示文字
                if (tile.includes('條') || tile.includes('筒')) {
                    createTilePattern(tile, tileElement);
                } else {
                    tileElement.textContent = tile;
                }
                
                tileElement.onclick = () => discardTile(index);
                container.appendChild(tileElement);
            });
        }
        
        // 獲取麻將牌樣式類別
        function getTileClass(tile) {
            if (tile.includes('萬')) return 'tile-wan';
            if (tile.includes('條')) return 'tile-tiao';
            if (tile.includes('筒')) return 'tile-tong';
            if (['東', '南', '西', '北'].includes(tile)) return 'tile-feng';
            if (tile === '中') return 'tile-zhong';
            if (tile === '發') return 'tile-fa';
            if (tile === '白') return 'tile-bai';
            if (['春', '夏', '秋', '冬', '梅', '蘭', '竹', '菊'].includes(tile)) return 'tile-hua';
            return '';
        }
        
        // 創建特殊麻將牌圖案
        function createTilePattern(tile, element) {
            if (tile.includes('條')) {
                const num = parseInt(tile[0]);
                element.innerHTML = '';
                element.style.fontSize = '0';
                
                // 創建竹子圖案
                for (let i = 0; i < num; i++) {
                    const bamboo = document.createElement('div');
                    bamboo.style.cssText = `
                        position: absolute;
                        width: 4px;
                        height: 80%;
                        background: linear-gradient(to bottom, #28a745, #20c997);
                        border-radius: 2px;
                        left: ${20 + (i * 8)}%;
                        top: 10%;
                    `;
                    element.appendChild(bamboo);
                }
            } else if (tile.includes('筒')) {
                const num = parseInt(tile[0]);
                element.innerHTML = '';
                element.style.fontSize = '0';
                
                // 創建筒子圖案
                for (let i = 0; i < num; i++) {
                    const circle = document.createElement('div');
                    const size = num <= 4 ? '16px' : '12px';
                    const gridCols = num <= 4 ? 2 : 3;
                    const row = Math.floor(i / gridCols);
                    const col = i % gridCols;
                    
                    circle.style.cssText = `
                        position: absolute;
                        width: ${size};
                        height: ${size};
                        border: 2px solid #1976d2;
                        border-radius: 50%;
                        background: #fff;
                        left: ${25 + (col * 20)}%;
                        top: ${25 + (row * 25)}%;
                    `;
                    element.appendChild(circle);
                }
            }
        }

        // 渲染電腦手牌數量
        function renderComputerHands(handCounts) {
            for (let i = 0; i < 3; i++) {
                const container = document.getElementById(`computerTiles${i + 1}`);
                container.innerHTML = '';
                
                const count = handCounts[i];
                const isVertical = i === 0 || i === 2; // 左右側玩家
                
                for (let j = 0; j < count; j++) {
                    const tileElement = document.createElement('div');
                    tileElement.className = 'mahjong-tile computer-tile';
                    
                    if (isVertical) {
                        tileElement.style.cssText = 'width: 20px; height: 30px; margin: 1px 0;';
                    } else {
                        tileElement.style.cssText = 'width: 25px; height: 35px; margin: 0 1px;';
                    }
                    
                    container.appendChild(tileElement);
                }
            }
        }

        // 渲染打出的牌
        function renderDiscardedTiles(tiles) {
            const container = document.getElementById('discardedTiles');
            if (!container) return;
            
            container.innerHTML = '';
            
            tiles.forEach(tile => {
                const tileElement = document.createElement('div');
                tileElement.className = 'mahjong-tile discarded-tile ' + getTileClass(tile);
                
                // 對於條子和筒子牌，創建圖案；其他牌顯示文字
                if (tile.includes('條') || tile.includes('筒')) {
                    createTilePattern(tile, tileElement);
                } else {
                    tileElement.textContent = tile;
                }
                
                container.appendChild(tileElement);
            });
        }

        // 渲染玩家已組合牌
        function renderPlayerMelded(melded) {
            const container = document.getElementById('playerMelded');
            container.innerHTML = '';
            
            melded.forEach(meld => {
                const meldGroup = document.createElement('div');
                meldGroup.style.cssText = 'display: flex; gap: 1px;';
                
                meld.forEach(tile => {
                    const tileElement = document.createElement('div');
                    tileElement.className = 'mahjong-tile melded-tile ' + getTileClass(tile);
                    
                    // 對於條子和筒子牌，創建圖案；其他牌顯示文字
                    if (tile.includes('條') || tile.includes('筒')) {
                        createTilePattern(tile, tileElement);
                    } else {
                        tileElement.textContent = tile;
                    }
                    
                    meldGroup.appendChild(tileElement);
                });
                
                container.appendChild(meldGroup);
            });
        }

        // 更新遊戲狀態顯示
        function updateGameStatus(remainingTiles, currentPlayer) {
            document.getElementById('remainingTiles').textContent = remainingTiles;
            document.getElementById('currentPlayer').textContent = currentPlayer;
        }

        // 顯示動作提示
        function showActionPrompt(actions) {
            const prompt = document.getElementById('actionPrompt');
            prompt.style.display = 'block';
        }

        // 隱藏動作提示
        function hideActionPrompt() {
            const prompt = document.getElementById('actionPrompt');
            prompt.style.display = 'none';
        }

        // 顯示訊息
        function showMessage(message, type) {
            const messageDiv = document.getElementById('gameMessage');
            messageDiv.className = `alert alert-${type} mt-3`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // 獲取玩家名稱
        function getPlayerName(playerIndex) {
            const names = ['你', '電腦1', '電腦2', '電腦3'];
            return names[playerIndex] || '未知';
        }
    </script>
</body>
</html>