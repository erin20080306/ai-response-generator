<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D 像素牧場物語</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        
        .game-title {
            color: #2F4F4F;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            font-size: 28px;
            text-align: center;
        }
        
        .game-container {
            background: linear-gradient(180deg, #8FBC8F 0%, #556B2F 100%);
            border: 4px solid #8B4513;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            max-width: 1200px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            color: #fff3d6;
        }
        
        .game-stats {
            display: flex;
            gap: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .game-main {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        #farmCanvas {
            border: 3px solid #8B4513;
            border-radius: 8px;
            background: #87CEEB;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            cursor: crosshair;
        }
        
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 250px;
            max-width: 300px;
        }
        
        .control-panel {
            background: #2F4F4F;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4682B4;
            color: #fff3d6;
        }
        
        .control-panel h3 {
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
            color: #FFD700;
        }
        
        .control-keys {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin: 10px 0;
            justify-items: center;
        }
        
        .key {
            background: linear-gradient(145deg, #4169E1, #1E90FF);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            min-width: 40px;
        }
        
        .key:nth-child(1) { grid-column: 2; }
        .key:nth-child(2) { grid-column: 1; grid-row: 2; }
        .key:nth-child(3) { grid-column: 2; grid-row: 2; }
        .key:nth-child(4) { grid-column: 3; grid-row: 2; }
        
        .tool-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .tool-btn {
            background: linear-gradient(145deg, #32CD32, #228B22);
            color: white;
            border: none;
            padding: 8px 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 11px;
            font-weight: bold;
        }
        
        .tool-btn:hover {
            background: linear-gradient(145deg, #3CB371, #32CD32);
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            color: #333;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: pixelBounce 1s infinite;
        }
        
        @keyframes pixelBounce {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
            100% { transform: translateY(0px); }
        }
        
        .game-info {
            background: #1C1C1C;
            color: #00FF00;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            min-height: 60px;
            border: 1px solid #00FF00;
            line-height: 1.4;
        }
        
        .instructions {
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-width: 800px;
            text-align: center;
        }
        
        .instructions h3 {
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .instructions p {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .game-main {
                flex-direction: column;
                align-items: center;
            }
            
            #farmCanvas {
                width: 100%;
                max-width: 600px;
                height: auto;
            }
            
            .game-controls {
                width: 100%;
                max-width: 600px;
            }
            
            .tool-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <h1 class="game-title">🏡 2D 像素牧場物語</h1>
    
    <div class="game-container">
        <div class="game-header">
            <h2>歡迎來到你的農場！</h2>
            <div class="game-stats">
                <span>💰 <span id="money">500</span></span>
                <span>🌱 種子: <span id="seeds">10</span></span>
                <span>⏰ <span id="gameTime">06:00</span></span>
            </div>
        </div>
        
        <div class="game-main">
            <canvas id="farmCanvas" width="800" height="600"></canvas>
            
            <div class="game-controls">
                <div class="control-panel">
                    <h3>🎮 控制方式</h3>
                    <div class="control-keys">
                        <div class="key">↑</div>
                        <div class="key">←</div>
                        <div class="key">↓</div>
                        <div class="key">→</div>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                        <div class="key" style="background: linear-gradient(145deg, #FF6B6B, #E55555);">A</div>
                        <div class="key" style="background: linear-gradient(145deg, #4ECDC4, #45B7D1);">B</div>
                    </div>
                    <p style="font-size: 12px; text-align: center; margin-top: 10px;">
                        方向鍵移動 • A鍵使用工具 • B鍵互動
                    </p>
                </div>
                
                <div class="control-panel">
                    <h3>🔧 工具欄</h3>
                    <div class="tool-buttons">
                        <button class="tool-btn active" onclick="farmGame.selectTool('hand')" data-tool="hand">
                            🤚 手
                        </button>
                        <button class="tool-btn" onclick="farmGame.selectTool('hoe')" data-tool="hoe">
                            🔨 鋤頭
                        </button>
                        <button class="tool-btn" onclick="farmGame.selectTool('watering_can')" data-tool="watering_can">
                            🚿 澆水壺
                        </button>
                        <button class="tool-btn" onclick="farmGame.selectTool('seeds')" data-tool="seeds">
                            🌱 種子
                        </button>
                    </div>
                </div>
                
                <div class="control-panel">
                    <h3>📋 遊戲資訊</h3>
                    <div id="gameInfo" class="game-info">
                        歡迎來到牧場！使用方向鍵移動，A鍵使用工具，B鍵與動物互動。
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <h3>🎯 遊戲說明</h3>
        <p>🚜 使用鋤頭整地，種植種子，澆水讓作物成長</p>
        <p>🐄 與農場動物互動可以獲得金錢和快樂</p>
        <p>🌾 收穫成熟的作物可以賺取金錢和種子</p>
        <p>🗺️ 右上角的迷你地圖顯示你和動物的位置</p>
        <p>🎮 A鍵使用當前工具，B鍵與動物和作物互動</p>
        <p>💡 點擊動物也可以進行互動哦！</p>
    </div>

    <script>
        // 2D 像素風格牧場物語遊戲
        console.log('載入 2D 牧場物語遊戲...');

        class FarmStory2D {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.gameState = {
                    player: {
                        x: 400,
                        y: 300,
                        width: 32,
                        height: 32,
                        speed: 4,
                        direction: 'down',
                        animFrame: 0,
                        animTimer: 0
                    },
                    camera: {
                        x: 0,
                        y: 0
                    },
                    map: {
                        width: 40,
                        height: 30,
                        tileSize: 32
                    },
                    keys: {},
                    gameLoop: null,
                    tools: {
                        current: 'hand',
                        watering_can: true,
                        hoe: true,
                        seeds: 10
                    },
                    crops: [],
                    animals: [
                        { type: 'cow', x: 200, y: 150, animFrame: 0 },
                        { type: 'chicken', x: 350, y: 180, animFrame: 0 },
                        { type: 'sheep', x: 180, y: 200, animFrame: 0 }
                    ],
                    time: 0,
                    money: 500
                };
                
                // 地圖數據 (0=草地, 1=泥土, 2=石頭, 3=水, 4=房屋, 5=農田)
                this.generateMap();
                this.init();
            }
            
            generateMap() {
                this.gameState.mapData = [];
                for (let y = 0; y < this.gameState.map.height; y++) {
                    this.gameState.mapData[y] = [];
                    for (let x = 0; x < this.gameState.map.width; x++) {
                        if (x < 2 || x > 37 || y < 2 || y > 27) {
                            this.gameState.mapData[y][x] = 3; // 邊界水域
                        } else if (x > 10 && x < 20 && y > 10 && y < 20) {
                            this.gameState.mapData[y][x] = 5; // 農田區域
                        } else if (Math.random() < 0.1) {
                            this.gameState.mapData[y][x] = 2; // 隨機石頭
                        } else if (x > 5 && x < 15 && y > 5 && y < 10) {
                            this.gameState.mapData[y][x] = 1; // 泥土區域
                        } else {
                            this.gameState.mapData[y][x] = 0; // 草地
                        }
                    }
                }
                
                // 添加房屋
                this.gameState.mapData[8][8] = 4;
                this.gameState.mapData[8][9] = 4;
                this.gameState.mapData[9][8] = 4;
                this.gameState.mapData[9][9] = 4;
            }
            
            init() {
                this.canvas = document.getElementById('farmCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // 設置像素風格渲染
                this.ctx.imageSmoothingEnabled = false;
                this.canvas.style.imageRendering = 'pixelated';
                
                this.setupEventListeners();
                this.startGameLoop();
            }
            
            setupEventListeners() {
                // 鍵盤事件
                document.addEventListener('keydown', (e) => {
                    this.gameState.keys[e.code] = true;
                    
                    // 防止方向鍵滾動頁面
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'KeyA', 'KeyB'].includes(e.code)) {
                        e.preventDefault();
                    }
                    
                    // 工具使用 (A鍵)
                    if (e.code === 'KeyA') {
                        this.useTool();
                    }
                    
                    // 互動 (B鍵)
                    if (e.code === 'KeyB') {
                        this.interact();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.gameState.keys[e.code] = false;
                });
                
                // Canvas 點擊事件
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.handleCanvasClick(x, y);
                });
            }
            
            handleCanvasClick(x, y) {
                // 將畫面座標轉換為世界座標
                const worldX = x + this.gameState.camera.x;
                const worldY = y + this.gameState.camera.y;
                
                // 檢查是否點擊動物
                this.gameState.animals.forEach(animal => {
                    if (Math.abs(animal.x - worldX) < 32 && Math.abs(animal.y - worldY) < 32) {
                        this.interactWithAnimal(animal);
                    }
                });
            }
            
            startGameLoop() {
                this.gameState.gameLoop = setInterval(() => {
                    this.update();
                    this.render();
                }, 1000 / 60); // 60 FPS
            }
            
            update() {
                this.updatePlayer();
                this.updateCamera();
                this.updateTime();
                this.updateCrops();
                this.updateAnimals();
            }
            
            updatePlayer() {
                const player = this.gameState.player;
                let moved = false;
                let newX = player.x;
                let newY = player.y;
                
                // 更流暢的移動處理（對角線移動支援）
                if (this.gameState.keys['ArrowUp']) {
                    newY -= player.speed;
                    player.direction = 'up';
                    moved = true;
                }
                if (this.gameState.keys['ArrowDown']) {
                    newY += player.speed;
                    player.direction = 'down';
                    moved = true;
                }
                if (this.gameState.keys['ArrowLeft']) {
                    newX -= player.speed;
                    player.direction = 'left';
                    moved = true;
                }
                if (this.gameState.keys['ArrowRight']) {
                    newX += player.speed;
                    player.direction = 'right';
                    moved = true;
                }
                
                // 邊界檢查
                const mapWidth = this.gameState.map.width * this.gameState.map.tileSize;
                const mapHeight = this.gameState.map.height * this.gameState.map.tileSize;
                
                newX = Math.max(16, Math.min(mapWidth - 48, newX));
                newY = Math.max(16, Math.min(mapHeight - 48, newY));
                
                // 碰撞檢測（分別檢查X和Y軸）
                if (!this.checkCollisionAtPosition(newX, player.y)) {
                    player.x = newX;
                }
                if (!this.checkCollisionAtPosition(player.x, newY)) {
                    player.y = newY;
                }
                
                // 改進的動畫更新
                if (moved) {
                    player.animTimer++;
                    if (player.animTimer > 8) { // 更快的動畫速度
                        player.animFrame = (player.animFrame + 1) % 4;
                        player.animTimer = 0;
                    }
                } else {
                    player.animFrame = 0;
                    player.animTimer = 0;
                }
            }
            
            checkCollisionAtPosition(x, y) {
                const tileX = Math.floor(x / 32);
                const tileY = Math.floor(y / 32);
                
                // 檢查角色四個角落的碰撞
                const corners = [
                    { x: Math.floor(x / 32), y: Math.floor(y / 32) },
                    { x: Math.floor((x + 30) / 32), y: Math.floor(y / 32) },
                    { x: Math.floor(x / 32), y: Math.floor((y + 30) / 32) },
                    { x: Math.floor((x + 30) / 32), y: Math.floor((y + 30) / 32) }
                ];
                
                for (let corner of corners) {
                    if (this.gameState.mapData[corner.y] && 
                        this.gameState.mapData[corner.y][corner.x] === 3) {
                        return true; // 有碰撞
                    }
                }
                return false; // 無碰撞
            }
            

            
            updateCamera() {
                const player = this.gameState.player;
                this.gameState.camera.x = player.x - 400;
                this.gameState.camera.y = player.y - 300;
                
                // 相機邊界限制
                const mapWidth = this.gameState.map.width * this.gameState.map.tileSize;
                const mapHeight = this.gameState.map.height * this.gameState.map.tileSize;
                
                this.gameState.camera.x = Math.max(0, Math.min(mapWidth - 800, this.gameState.camera.x));
                this.gameState.camera.y = Math.max(0, Math.min(mapHeight - 600, this.gameState.camera.y));
            }
            
            updateTime() {
                this.gameState.time += 1/60;
                const hours = Math.floor(this.gameState.time * 24 / 3600) % 24 + 6;
                const minutes = Math.floor((this.gameState.time * 24 * 60 / 3600) % 60);
                const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
                const timeElement = document.getElementById('gameTime');
                if (timeElement) {
                    timeElement.textContent = timeStr;
                }
            }
            
            updateCrops() {
                this.gameState.crops.forEach(crop => {
                    crop.growthTime++;
                    if (crop.growthTime >= crop.maxGrowthTime && !crop.ready) {
                        crop.ready = true;
                        this.showInfo('🌾 作物成熟了！');
                    }
                });
            }
            
            updateAnimals() {
                this.gameState.animals.forEach(animal => {
                    animal.animFrame = Math.floor(this.gameState.time * 2) % 2;
                });
            }
            
            render() {
                // 清空畫布
                this.ctx.fillStyle = '#87CEEB';
                this.ctx.fillRect(0, 0, 800, 600);
                
                this.renderMap();
                this.renderCrops();
                this.renderAnimals();
                this.renderPlayer();
                this.renderUI();
            }
            
            renderMap() {
                const startX = Math.floor(this.gameState.camera.x / 32);
                const startY = Math.floor(this.gameState.camera.y / 32);
                const endX = Math.min(startX + 26, this.gameState.map.width);
                const endY = Math.min(startY + 20, this.gameState.map.height);
                
                for (let y = startY; y < endY; y++) {
                    for (let x = startX; x < endX; x++) {
                        if (this.gameState.mapData[y] && this.gameState.mapData[y][x] !== undefined) {
                            this.renderTile(x, y, this.gameState.mapData[y][x]);
                        }
                    }
                }
            }
            
            renderTile(x, y, tileType) {
                const screenX = x * 32 - this.gameState.camera.x;
                const screenY = y * 32 - this.gameState.camera.y;
                
                switch (tileType) {
                    case 0: // 草地
                        this.ctx.fillStyle = '#32CD32';
                        this.ctx.fillRect(screenX, screenY, 32, 32);
                        // 添加草地紋理
                        this.ctx.fillStyle = '#228B22';
                        for (let i = 0; i < 8; i++) {
                            const px = screenX + Math.random() * 32;
                            const py = screenY + Math.random() * 32;
                            this.ctx.fillRect(px, py, 2, 2);
                        }
                        break;
                        
                    case 1: // 泥土
                        this.ctx.fillStyle = '#8B4513';
                        this.ctx.fillRect(screenX, screenY, 32, 32);
                        break;
                        
                    case 2: // 石頭
                        this.ctx.fillStyle = '#696969';
                        this.ctx.fillRect(screenX, screenY, 32, 32);
                        this.ctx.fillStyle = '#A9A9A9';
                        this.ctx.fillRect(screenX + 4, screenY + 4, 24, 24);
                        break;
                        
                    case 3: // 水
                        this.ctx.fillStyle = '#4169E1';
                        this.ctx.fillRect(screenX, screenY, 32, 32);
                        // 水波效果
                        this.ctx.fillStyle = '#87CEEB';
                        const wave = Math.sin(this.gameState.time * 2) * 4;
                        this.ctx.fillRect(screenX + wave, screenY + 8, 32 - wave * 2, 8);
                        break;
                        
                    case 4: // 房屋
                        this.ctx.fillStyle = '#CD853F';
                        this.ctx.fillRect(screenX, screenY, 32, 32);
                        this.ctx.fillStyle = '#8B0000';
                        this.ctx.fillRect(screenX + 4, screenY, 24, 16);
                        break;
                        
                    case 5: // 農田
                        this.ctx.fillStyle = '#654321';
                        this.ctx.fillRect(screenX, screenY, 32, 32);
                        // 農田溝壑
                        this.ctx.fillStyle = '#4A4A4A';
                        for (let i = 0; i < 4; i++) {
                            this.ctx.fillRect(screenX, screenY + i * 8, 32, 2);
                        }
                        break;
                }
            }
            
            renderPlayer() {
                const player = this.gameState.player;
                const screenX = player.x - this.gameState.camera.x;
                const screenY = player.y - this.gameState.camera.y;
                
                // 繪製精美的像素風格角色
                this.drawPixelCharacter(screenX, screenY, player.direction, player.animFrame);
            }
            
            drawPixelCharacter(x, y, direction, animFrame) {
                const ctx = this.ctx;
                
                // 設定像素精確繪製
                ctx.imageSmoothingEnabled = false;
                
                // 角色基本配色（更生動的顏色）
                const colors = {
                    skin: '#F5DEB3',
                    hair: '#8B4513',
                    shirt: '#228B22',
                    pants: '#4169E1',
                    shoes: '#8B4513',
                    eye: '#000000',
                    outline: '#4A4A4A',
                    shirtDetail: '#32CD32',
                    pantsDetail: '#6495ED'
                };
                
                // 繪製角色輪廓（陰影效果）
                ctx.fillStyle = colors.outline;
                ctx.fillRect(x + 7, y + 1, 18, 30);
                
                // 繪製頭部
                ctx.fillStyle = colors.skin;
                ctx.fillRect(x + 8, y + 2, 16, 14);
                
                // 繪製頭髮（根據方向調整）
                ctx.fillStyle = colors.hair;
                switch (direction) {
                    case 'up':
                        ctx.fillRect(x + 6, y, 20, 8);
                        ctx.fillRect(x + 8, y + 8, 16, 4);
                        break;
                    case 'down':
                        ctx.fillRect(x + 6, y, 20, 10);
                        ctx.fillRect(x + 8, y + 10, 16, 2);
                        break;
                    case 'left':
                        ctx.fillRect(x + 6, y, 18, 8);
                        ctx.fillRect(x + 8, y + 8, 14, 4);
                        break;
                    case 'right':
                        ctx.fillRect(x + 8, y, 18, 8);
                        ctx.fillRect(x + 10, y + 8, 14, 4);
                        break;
                }
                
                // 繪製眼睛
                ctx.fillStyle = colors.eye;
                switch (direction) {
                    case 'up':
                        // 背面，不顯示眼睛
                        break;
                    case 'down':
                        ctx.fillRect(x + 11, y + 8, 2, 2);
                        ctx.fillRect(x + 19, y + 8, 2, 2);
                        break;
                    case 'left':
                        ctx.fillRect(x + 10, y + 8, 2, 2);
                        break;
                    case 'right':
                        ctx.fillRect(x + 20, y + 8, 2, 2);
                        break;
                }
                
                // 繪製嘴巴（正面和側面）
                if (direction === 'down') {
                    ctx.fillStyle = '#FF6B6B';
                    ctx.fillRect(x + 15, y + 12, 2, 1);
                }
                
                // 繪製身體
                ctx.fillStyle = colors.shirt;
                ctx.fillRect(x + 8, y + 16, 16, 12);
                
                // 添加衣服細節
                ctx.fillStyle = colors.shirtDetail;
                ctx.fillRect(x + 10, y + 18, 12, 2);
                ctx.fillRect(x + 14, y + 21, 4, 4);
                
                // 繪製手臂（根據動畫幀調整）
                ctx.fillStyle = colors.skin;
                if (animFrame % 2 === 0) {
                    // 正常姿勢
                    ctx.fillRect(x + 4, y + 18, 4, 8);
                    ctx.fillRect(x + 24, y + 18, 4, 8);
                } else {
                    // 行走姿勢
                    ctx.fillRect(x + 4, y + 20, 4, 6);
                    ctx.fillRect(x + 24, y + 16, 4, 10);
                }
                
                // 繪製褲子
                ctx.fillStyle = colors.pants;
                ctx.fillRect(x + 8, y + 28, 16, 8);
                
                // 添加褲子細節
                ctx.fillStyle = colors.pantsDetail;
                ctx.fillRect(x + 9, y + 30, 2, 4);
                ctx.fillRect(x + 21, y + 30, 2, 4);
                
                // 繪製腿部（行走動畫）
                ctx.fillStyle = colors.skin;
                if (animFrame % 2 === 0) {
                    // 正常站立
                    ctx.fillRect(x + 10, y + 36, 4, 6);
                    ctx.fillRect(x + 18, y + 36, 4, 6);
                } else {
                    // 行走動作
                    switch (direction) {
                        case 'up':
                        case 'down':
                            ctx.fillRect(x + 8, y + 36, 4, 6);
                            ctx.fillRect(x + 20, y + 36, 4, 6);
                            break;
                        case 'left':
                            ctx.fillRect(x + 10, y + 36, 4, 6);
                            ctx.fillRect(x + 16, y + 36, 4, 6);
                            break;
                        case 'right':
                            ctx.fillRect(x + 12, y + 36, 4, 6);
                            ctx.fillRect(x + 18, y + 36, 4, 6);
                            break;
                    }
                }
                
                // 繪製鞋子
                ctx.fillStyle = colors.shoes;
                if (animFrame % 2 === 0) {
                    ctx.fillRect(x + 9, y + 42, 6, 3);
                    ctx.fillRect(x + 17, y + 42, 6, 3);
                } else {
                    switch (direction) {
                        case 'up':
                        case 'down':
                            ctx.fillRect(x + 7, y + 42, 6, 3);
                            ctx.fillRect(x + 19, y + 42, 6, 3);
                            break;
                        case 'left':
                            ctx.fillRect(x + 9, y + 42, 6, 3);
                            ctx.fillRect(x + 15, y + 42, 6, 3);
                            break;
                        case 'right':
                            ctx.fillRect(x + 11, y + 42, 6, 3);
                            ctx.fillRect(x + 17, y + 42, 6, 3);
                            break;
                    }
                }
                
                // 添加工具指示器
                if (this.gameState.tools.current !== 'hand') {
                    this.drawToolIndicator(x, y);
                }
            }
            
            drawToolIndicator(x, y) {
                const ctx = this.ctx;
                const toolSize = 8;
                
                // 工具背景
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.fillRect(x + 26, y + 10, toolSize + 2, toolSize + 2);
                
                // 根據當前工具繪製圖標
                ctx.fillStyle = '#333';
                switch (this.gameState.tools.current) {
                    case 'hoe':
                        // 鋤頭圖標
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x + 27, y + 11, 2, toolSize);
                        ctx.fillStyle = '#A0522D';
                        ctx.fillRect(x + 27, y + 11, 6, 3);
                        break;
                    case 'watering_can':
                        // 澆水壺圖標
                        ctx.fillStyle = '#4682B4';
                        ctx.fillRect(x + 27, y + 13, 6, 4);
                        ctx.fillRect(x + 30, y + 11, 2, 2);
                        break;
                    case 'seeds':
                        // 種子圖標
                        ctx.fillStyle = '#32CD32';
                        ctx.fillRect(x + 28, y + 13, 2, 2);
                        ctx.fillRect(x + 30, y + 15, 2, 2);
                        ctx.fillRect(x + 29, y + 17, 2, 2);
                        break;
                }
            }
            
            renderAnimals() {
                this.gameState.animals.forEach(animal => {
                    const screenX = animal.x - this.gameState.camera.x;
                    const screenY = animal.y - this.gameState.camera.y;
                    
                    if (screenX > -32 && screenX < 832 && screenY > -32 && screenY < 632) {
                        this.renderAnimal(screenX, screenY, animal);
                    }
                });
            }
            
            renderAnimal(x, y, animal) {
                const ctx = this.ctx;
                ctx.imageSmoothingEnabled = false;
                
                switch (animal.type) {
                    case 'cow':
                        // 牛的陰影
                        ctx.fillStyle = 'rgba(0,0,0,0.2)';
                        ctx.fillRect(x + 2, y + 26, 30, 4);
                        
                        // 牛身體
                        ctx.fillStyle = '#FFFACD';
                        ctx.fillRect(x, y + 8, 32, 20);
                        
                        // 牛身體輪廓
                        ctx.fillStyle = '#F0E68C';
                        ctx.fillRect(x, y + 8, 32, 2);
                        ctx.fillRect(x, y + 26, 32, 2);
                        
                        // 牛頭
                        ctx.fillStyle = '#F5DEB3';
                        ctx.fillRect(x + 8, y, 16, 16);
                        
                        // 牛的耳朵
                        ctx.fillStyle = '#DEB887';
                        ctx.fillRect(x + 6, y + 2, 3, 6);
                        ctx.fillStyle = '#F5DEB3';
                        ctx.fillRect(x + 23, y + 2, 3, 6);
                        
                        // 牛的眼睛
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + 10, y + 4, 2, 2);
                        ctx.fillRect(x + 20, y + 4, 2, 2);
                        
                        // 牛的鼻子
                        ctx.fillStyle = '#FF69B4';
                        ctx.fillRect(x + 14, y + 10, 4, 2);
                        
                        // 牛的斑點
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(x + 4, y + 12, 6, 6);
                        ctx.fillRect(x + 20, y + 16, 6, 6);
                        ctx.fillRect(x + 12, y + 20, 4, 4);
                        
                        // 牛的腿
                        ctx.fillStyle = '#F0E68C';
                        ctx.fillRect(x + 4, y + 24, 3, 6);
                        ctx.fillRect(x + 10, y + 24, 3, 6);
                        ctx.fillRect(x + 19, y + 24, 3, 6);
                        ctx.fillRect(x + 25, y + 24, 3, 6);
                        break;
                        
                    case 'chicken':
                        // 雞的陰影
                        ctx.fillStyle = 'rgba(0,0,0,0.2)';
                        ctx.fillRect(x + 2, y + 22, 20, 3);
                        
                        // 雞身體
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(x + 4, y + 8, 20, 16);
                        
                        // 雞身體輪廓
                        ctx.fillStyle = '#F5F5F5';
                        ctx.fillRect(x + 4, y + 8, 20, 2);
                        ctx.fillRect(x + 4, y + 22, 20, 2);
                        
                        // 雞頭
                        ctx.fillStyle = '#FFE4E1';
                        ctx.fillRect(x + 8, y + 4, 12, 8);
                        
                        // 雞冠
                        ctx.fillStyle = '#FF0000';
                        ctx.fillRect(x + 12, y, 8, 4);
                        ctx.fillRect(x + 14, y - 2, 4, 2);
                        
                        // 雞的眼睛
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + 10, y + 6, 2, 2);
                        ctx.fillRect(x + 16, y + 6, 2, 2);
                        
                        // 雞的嘴
                        ctx.fillStyle = '#FFA500';
                        ctx.fillRect(x + 6, y + 8, 3, 2);
                        
                        // 雞的翅膀
                        ctx.fillStyle = '#F0F0F0';
                        ctx.fillRect(x + 2, y + 12, 6, 8);
                        ctx.fillRect(x + 20, y + 12, 6, 8);
                        
                        // 雞的尾巴
                        ctx.fillStyle = '#FFFF00';
                        ctx.fillRect(x + 22, y + 6, 4, 10);
                        ctx.fillRect(x + 24, y + 4, 3, 8);
                        
                        // 雞的腿
                        ctx.fillStyle = '#FFA500';
                        ctx.fillRect(x + 10, y + 22, 2, 4);
                        ctx.fillRect(x + 16, y + 22, 2, 4);
                        break;
                        
                    case 'sheep':
                        // 羊的陰影
                        ctx.fillStyle = 'rgba(0,0,0,0.2)';
                        ctx.fillRect(x + 2, y + 26, 28, 4);
                        
                        // 羊身體（毛茸茸）
                        ctx.fillStyle = '#FFFAFA';
                        ctx.fillRect(x, y + 8, 32, 20);
                        
                        // 羊毛質感
                        ctx.fillStyle = '#F0F8FF';
                        ctx.fillRect(x + 2, y + 10, 4, 4);
                        ctx.fillRect(x + 8, y + 12, 4, 4);
                        ctx.fillRect(x + 14, y + 10, 4, 4);
                        ctx.fillRect(x + 20, y + 12, 4, 4);
                        ctx.fillRect(x + 26, y + 10, 4, 4);
                        ctx.fillRect(x + 6, y + 18, 4, 4);
                        ctx.fillRect(x + 16, y + 20, 4, 4);
                        ctx.fillRect(x + 22, y + 18, 4, 4);
                        
                        // 羊頭
                        ctx.fillStyle = '#F5DEB3';
                        ctx.fillRect(x + 10, y, 12, 12);
                        
                        // 羊眼睛
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + 12, y + 4, 2, 2);
                        ctx.fillRect(x + 18, y + 4, 2, 2);
                        
                        // 羊鼻子
                        ctx.fillStyle = '#000';
                        ctx.fillRect(x + 15, y + 8, 2, 2);
                        
                        // 羊的腿
                        ctx.fillStyle = '#F5DEB3';
                        ctx.fillRect(x + 4, y + 24, 3, 6);
                        ctx.fillRect(x + 10, y + 24, 3, 6);
                        ctx.fillRect(x + 19, y + 24, 3, 6);
                        ctx.fillRect(x + 25, y + 24, 3, 6);
                        break;
                }
            }
            
            renderCrops() {
                this.gameState.crops.forEach(crop => {
                    const screenX = crop.x - this.gameState.camera.x;
                    const screenY = crop.y - this.gameState.camera.y;
                    
                    if (screenX > -32 && screenX < 832 && screenY > -32 && screenY < 632) {
                        this.renderCrop(screenX, screenY, crop);
                    }
                });
            }
            
            renderCrop(x, y, crop) {
                const ctx = this.ctx;
                ctx.imageSmoothingEnabled = false;
                
                const growthStage = Math.min(3, Math.floor(crop.growthTime / (crop.maxGrowthTime / 4)));
                
                // 土壤基底
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(x, y + 24, 32, 8);
                
                // 根據成長階段繪製不同的作物
                switch (growthStage) {
                    case 0:
                        // 種子階段
                        ctx.fillStyle = '#654321';
                        ctx.fillRect(x + 14, y + 26, 4, 2);
                        ctx.fillRect(x + 12, y + 28, 2, 2);
                        ctx.fillRect(x + 18, y + 28, 2, 2);
                        break;
                        
                    case 1:
                        // 幼苗階段
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(x + 14, y + 20, 4, 12);
                        ctx.fillStyle = '#32CD32';
                        ctx.fillRect(x + 12, y + 18, 2, 4);
                        ctx.fillRect(x + 18, y + 18, 2, 4);
                        break;
                        
                    case 2:
                        // 成長階段
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(x + 14, y + 16, 4, 16);
                        ctx.fillStyle = '#32CD32';
                        ctx.fillRect(x + 10, y + 14, 4, 8);
                        ctx.fillRect(x + 18, y + 14, 4, 8);
                        ctx.fillRect(x + 12, y + 12, 2, 6);
                        ctx.fillRect(x + 18, y + 12, 2, 6);
                        break;
                        
                    case 3:
                        // 成熟階段
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(x + 14, y + 12, 4, 20);
                        
                        // 葉子
                        ctx.fillStyle = '#32CD32';
                        ctx.fillRect(x + 8, y + 10, 6, 10);
                        ctx.fillStyle = '#228B22';
                        ctx.fillRect(x + 18, y + 10, 6, 10);
                        
                        if (crop.ready) {
                            // 成熟的果實
                            ctx.fillStyle = '#FFD700';
                            ctx.fillRect(x + 10, y + 8, 6, 6);
                            ctx.fillRect(x + 16, y + 6, 6, 6);
                            ctx.fillRect(x + 12, y + 4, 4, 4);
                            
                            // 果實高光
                            ctx.fillStyle = '#FFFF00';
                            ctx.fillRect(x + 11, y + 9, 2, 2);
                            ctx.fillRect(x + 17, y + 7, 2, 2);
                            ctx.fillRect(x + 13, y + 5, 2, 2);
                        } else {
                            // 未成熟的果實
                            ctx.fillStyle = '#90EE90';
                            ctx.fillRect(x + 12, y + 8, 4, 4);
                            ctx.fillRect(x + 16, y + 10, 4, 4);
                        }
                        break;
                }
                
                // 添加一些細節（小草、雜草）
                if (Math.random() < 0.3) {
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(x + 2, y + 28, 2, 4);
                    ctx.fillRect(x + 28, y + 26, 2, 6);
                }
                        
                        this.ctx.fillRect(screenX + 14, screenY + 32 - height, 4, height);
                        
                        if (crop.ready) {
                            // 成熟的作物有花朵
                            this.ctx.fillStyle = '#FFD700';
                            this.ctx.fillRect(screenX + 12, screenY + 16, 8, 8);
                        }
                    }
                });
            }
            
            renderUI() {
                // 工具提示
                if (this.gameState.tools.current !== 'hand') {
                    this.ctx.fillStyle = 'rgba(0,0,0,0.7)';
                    this.ctx.fillRect(10, 10, 200, 30);
                    this.ctx.fillStyle = '#FFF';
                    this.ctx.font = '16px monospace';
                    this.ctx.fillText(`當前工具: ${this.getToolName()}`, 20, 30);
                }
                
                // 迷你地圖
                this.renderMiniMap();
            }
            
            renderMiniMap() {
                const miniMapSize = 120;
                const miniMapX = 800 - miniMapSize - 10;
                const miniMapY = 10;
                
                this.ctx.fillStyle = 'rgba(0,0,0,0.7)';
                this.ctx.fillRect(miniMapX, miniMapY, miniMapSize, miniMapSize);
                
                const scaleX = miniMapSize / (this.gameState.map.width * 32);
                const scaleY = miniMapSize / (this.gameState.map.height * 32);
                
                // 玩家位置
                const playerMiniX = miniMapX + this.gameState.player.x * scaleX;
                const playerMiniY = miniMapY + this.gameState.player.y * scaleY;
                
                this.ctx.fillStyle = '#FF0000';
                this.ctx.fillRect(playerMiniX - 2, playerMiniY - 2, 4, 4);
                
                // 動物位置
                this.ctx.fillStyle = '#FFFF00';
                this.gameState.animals.forEach(animal => {
                    const animalMiniX = miniMapX + animal.x * scaleX;
                    const animalMiniY = miniMapY + animal.y * scaleY;
                    this.ctx.fillRect(animalMiniX - 1, animalMiniY - 1, 2, 2);
                });
            }
            
            selectTool(tool) {
                this.gameState.tools.current = tool;
                
                // 更新UI
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
                
                this.showInfo(`選擇了: ${this.getToolName()}`);
            }
            
            getToolName() {
                const names = {
                    'hand': '手',
                    'hoe': '鋤頭',
                    'watering_can': '澆水壺',
                    'seeds': '種子'
                };
                return names[this.gameState.tools.current] || '未知';
            }
            
            useTool() {
                const player = this.gameState.player;
                const tileX = Math.floor(player.x / 32);
                const tileY = Math.floor(player.y / 32);
                
                switch (this.gameState.tools.current) {
                    case 'hoe':
                        this.hoeTile(tileX, tileY);
                        break;
                    case 'watering_can':
                        this.waterCrops(tileX, tileY);
                        break;
                    case 'seeds':
                        this.plantSeeds(tileX, tileY);
                        break;
                }
            }
            
            hoeTile(x, y) {
                if (this.gameState.mapData[y] && this.gameState.mapData[y][x] === 0) {
                    this.gameState.mapData[y][x] = 5; // 轉換為農田
                    this.showInfo('整地完成！');
                }
            }
            
            plantSeeds(x, y) {
                if (this.gameState.tools.seeds > 0 && 
                    this.gameState.mapData[y] && 
                    this.gameState.mapData[y][x] === 5) {
                    
                    // 檢查是否已有作物
                    const existingCrop = this.gameState.crops.find(crop => 
                        Math.floor(crop.x / 32) === x && Math.floor(crop.y / 32) === y
                    );
                    
                    if (!existingCrop) {
                        this.gameState.crops.push({
                            x: x * 32 + 16,
                            y: y * 32 + 16,
                            growthTime: 0,
                            maxGrowthTime: 1800, // 30秒
                            ready: false
                        });
                        
                        this.gameState.tools.seeds--;
                        this.updateUI();
                        this.showInfo('種子已種植！');
                    } else {
                        this.showInfo('這裡已經有作物了！');
                    }
                } else if (this.gameState.tools.seeds <= 0) {
                    this.showInfo('沒有種子了！');
                } else {
                    this.showInfo('需要在農田上種植！');
                }
            }
            
            waterCrops(x, y) {
                const crop = this.gameState.crops.find(crop => 
                    Math.floor(crop.x / 32) === x && Math.floor(crop.y / 32) === y
                );
                
                if (crop && !crop.ready) {
                    crop.growthTime += 300; // 加速成長
                    this.showInfo('澆水完成！');
                } else {
                    this.showInfo('這裡沒有需要澆水的作物！');
                }
            }
            
            interact() {
                const player = this.gameState.player;
                
                // 檢查是否與動物互動
                this.gameState.animals.forEach(animal => {
                    const distance = Math.sqrt(
                        Math.pow(player.x - animal.x, 2) + 
                        Math.pow(player.y - animal.y, 2)
                    );
                    
                    if (distance < 50) {
                        this.interactWithAnimal(animal);
                    }
                });
                
                // 檢查是否收割作物
                this.gameState.crops.forEach((crop, index) => {
                    const distance = Math.sqrt(
                        Math.pow(player.x - crop.x, 2) + 
                        Math.pow(player.y - crop.y, 2)
                    );
                    
                    if (distance < 32 && crop.ready) {
                        this.harvestCrop(index);
                    }
                });
            }
            
            interactWithAnimal(animal) {
                const messages = {
                    'cow': ['🐄 哞～', '🥛 牛兒很開心！', '🐄 牛兒想要更多草料'],
                    'chicken': ['🐔 咯咯咯～', '🥚 下了一顆蛋！', '🐔 雞雞很活潑'],
                    'sheep': ['🐑 咩～', '🧶 羊毛很蓬鬆！', '🐑 羊咩咩很溫順']
                };
                
                const animalMessages = messages[animal.type] || ['🐾 動物很友好！'];
                const randomMessage = animalMessages[Math.floor(Math.random() * animalMessages.length)];
                
                this.showInfo(randomMessage);
                
                // 獲得金錢
                this.gameState.money += 10;
                this.updateUI();
            }
            
            harvestCrop(index) {
                this.gameState.crops.splice(index, 1);
                this.gameState.money += 50;
                this.gameState.tools.seeds += 2; // 收成時獲得種子
                this.updateUI();
                this.showInfo('🌾 收成成功！獲得 50 金幣和 2 顆種子');
            }
            
            showInfo(message) {
                const infoElement = document.getElementById('gameInfo');
                if (infoElement) {
                    // 添加動畫效果
                    infoElement.style.transform = 'scale(1.05)';
                    infoElement.style.color = '#00FF00';
                    infoElement.textContent = message;
                    
                    // 重置樣式
                    setTimeout(() => {
                        infoElement.style.transform = 'scale(1)';
                        infoElement.style.color = '#00FF00';
                    }, 200);
                    
                    // 恢復預設文字
                    setTimeout(() => {
                        infoElement.textContent = '使用方向鍵移動，A鍵使用工具，B鍵互動。';
                    }, 3000);
                }
            }
            
            updateUI() {
                const moneyElement = document.getElementById('money');
                const seedsElement = document.getElementById('seeds');
                
                if (moneyElement) moneyElement.textContent = this.gameState.money;
                if (seedsElement) seedsElement.textContent = this.gameState.tools.seeds;
            }
        }

        // 全域變數
        let farmGame = null;

        // 啟動遊戲
        window.addEventListener('DOMContentLoaded', function() {
            farmGame = new FarmStory2D();
            console.log('2D 牧場物語遊戲已啟動！');
        });
    </script>
</body>
</html>